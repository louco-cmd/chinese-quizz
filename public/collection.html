<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Âä†Ê≤πÔºÅCollection</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  #card-container,
  #list-container {
    transition: opacity 0.5s ease, transform 0.5s ease, max-height 0.5s ease-in-out;
  }

  .hidden {
    opacity: 0;
    transform: translateY(50px);
    pointer-events: none;
    /* Correction Cl√© 1 : Utilisation de max-height et overflow */
    max-height: 0;
    overflow: hidden;
    /* La visibilit√© permet d'assurer que l'√©l√©ment est compl√®tement ignor√© */
    visibility: hidden;
  }

  .visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
    /* Correction Cl√© 2 : Une grande valeur fixe pour la transition */
    max-height: 2000px; /* Doit √™tre plus grand que le contenu de la liste/carte */
    visibility: visible;
  }

  #listBody tr {
    cursor: pointer;
    transition: background-color 0.2s;
  }

  #listBody tr:hover {
    background-color: rgba(0, 123, 255, 0.1); /* light blue effect */
  }

  html,
  body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }

  /* La couleur de fond de la carte */
  .card-custom-bg {
    background-color: #f7fcf7; /* Tr√®s clair */
    border: 1px solid #c8e6c9;
  }

  /* Classe pour le pinyin en grande taille */
  .fs-pinyin {
    font-size: 2.25rem; /* 36px */
  }

 .fs-chinese {
    font-size: 6.25rem; /* 100px */
    line-height: 1.2;
}

  /* Nouvelle classe pour les caract√®res chinois plus petits (4+ caract√®res) */
  .fs-chinese-small {
      font-size: 4.25rem; /* 84px */ /* Ajust√© √† votre demande */
      line-height: 1.2;
  }


  /* √âtiquette HSK verte */
  .hsk-tag-custom {
    background-color: white;
    color: #4CAF50; /* Vert sp√©cifique pour le texte */
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border-radius: 0.25rem; /* Bootstrap small radius */
  }

  /* Texte secondaire / Note de contexte */
  .text-context {
    color: #999;
    font-size: 0.875rem; /* 14px */
  }
  .text-box {
   min-height: 170px;
   align-content: center;
  }
</style>
  <!-- Ajoute ces lignes -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Ic√¥nes pour iOS -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- D√©tection PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-primary navbar-dark px-2">
  <div class="container-fluid d-flex justify-content-between">
    <a class="navbar-brand text-white cursor-pointer fw-bold" onclick="window.location='/dashboard'">Âä†Ê≤πÔºÅ</a>
    <div class="d-flex">
      <button id="collectionBtn" class="btn btn-outline-light w-auto" onclick="window.location='/dashboard'">Back to home</button>
    </div>
  </div>
</nav>

<section class="section d-flex flex-column align-items-center mt-4">
  <div id="card-container" class="d-flex justify-content-center visible mb-3 position-relative"></div>

  <div id="list-container" class="container mt-4 hidden">
    <div class="mb-3" style="max-width: 400px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Looking for a word...">
    </div>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Chinese</th>
          <th>Pinyin</th>
          <th>English</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between w-100" style="max-width: 18rem;">
    <button id="prevBtn" class="btn btn-primary rounded-circle px-3 py-2">‚Äπ</button>
    <button id="nextBtn" class="btn btn-primary rounded-circle px-3 py-2">‚Ä∫</button>
  </div>
</section>

<!-- Modal Bootstrap -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Word</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editForm" class="p-3">
        <input type="hidden" id="editId" />
        <div class="mb-3"><label for="editChinese" class="form-label">Chinese</label><input type="text" class="form-control" id="editChinese" required></div>
        <div class="mb-3"><label for="editPinyin" class="form-label">Pinyin</label><input type="text" class="form-control" id="editPinyin"></div>
        <div class="mb-3"><label for="editEnglish" class="form-label">English</label><input type="text" class="form-control" id="editEnglish"></div>
        <div class="mb-3"><label for="editDescription" class="form-label">Description</label><textarea class="form-control" id="editDescription" rows="3"></textarea></div>
        <div class="text-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

  let words=[], idx=0;
let touchStartY = 0;
const cardContainer=document.getElementById('card-container');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const listContainer=document.getElementById('list-container');
const listBody=document.getElementById('listBody');
const searchInput = document.getElementById('searchInput');

// modal
const editModal=document.getElementById('editModal');
const editForm=document.getElementById('editForm');
const editId=document.getElementById('editId');
const editChinese=document.getElementById('editChinese');
const editPinyin=document.getElementById('editPinyin');
const editEnglish=document.getElementById('editEnglish');
const editDescription=document.getElementById('editDescription');

// Load words
async function loadWords(){
  const res=await fetch('/mes-mots'); 
  words=await res.json();
  if(!words.length){
    cardContainer.innerHTML='<p>No words yet.</p>';
    return;
  }
  idx=0; 
  showCard();
  showList();
}

// scroll control
cardContainer.addEventListener('wheel', (e) => {
  const canScroll = cardContainer.scrollHeight > cardContainer.clientHeight;
  
  // Si la carte tient dans le conteneur, on autorise le toggle
  if(!canScroll && Math.abs(e.deltaY) > 30){
    toggleView('list');
  }
});

//create card element
function createCardElement(word) {
  const card = document.createElement('div');
  card.classList.add('col', 'mb-4'); 
  
  const hskLevelDisplay = word.hsk || 'Street';
  const chineseFontSizeClass = (word.chinese && word.chinese.length >= 3) ? 'fs-chinese-small' : 'fs-chinese';

  card.innerHTML = `
    <div class="card card-custom-bg rounded-4 shadow-lg p-3 mx-auto" style="width: 320px; height: 500px; position: relative;">

        <div class="position-absolute top-0 end-0 mt-3 me-3">
            <span class="hsk-tag-custom py-1 px-2 border border-light">HSK : ${hskLevelDisplay}</span>
        </div>

        <div class="bg-white border rounded-3 p-4 py-2 mt-3 flex-grow-0">
            <!-- MODIFICATION : Ajout d'un data-id au lieu d'un id -->
            <div class="text-dark text-center text-box ${chineseFontSizeClass} chinese-container" data-word-id="${word.id}">
                ${word.chinese}
            </div>
        </div>

        <div class="flex-grow-1 d-flex flex-column justify-content-between">
            <div>
                <div class="fs-pinyin fw-bold text-dark mb-1">${word.pinyin || ''}</div>
                <div class="fs-5 text-success mb-3">${word.english || 'No Translation'}</div>
                <div class="pt-3 border-top border-light-subtle">
                    <div class="text-context">${word.description || 'No description provided.'}</div>
                </div>
            </div>
            <a href="#" class="btn btn-link text-success edit-btn mt-auto">‚úèÔ∏è Edit</a>
        </div>
    </div>
  `;

  // Debug : v√©rifie si l'√©l√©ment existe
  const chineseContainer = card.querySelector('.chinese-container');
  console.log('üì¶ Container trouv√©:', chineseContainer);
  console.log('üî§ Mot chinois:', word.chinese);
  console.log('üÜî ID word:', word.id);

  if (chineseContainer && word.chinese) {
    transformChineseCharacters(word.chinese, chineseContainer);
  } else {
    console.error('‚ùå Container ou mot chinois manquant');
  }

  card.querySelector('.edit-btn').onclick = () => openEdit(word);
  return card;
}

// üöÄ VERSION SIMPLIFI√âE pour debug
function transformChineseCharacters(chineseWord, container) {
  console.log('üéØ transformChineseCharacters appel√©e');
  console.log('üî§ Mot:', chineseWord);
  console.log('üì¶ Container:', container);

  if (!container || !chineseWord) {
    console.error('‚ùå Container ou mot manquant');
    return;
  }

  const characters = Array.from(chineseWord);
  console.log('üî° Caract√®res d√©tect√©s:', characters);
  
  // Sauvegarde le texte original au cas o√π
  const originalText = container.textContent;
  
  container.innerHTML = '';
  
  characters.forEach((character, index) => {
    const span = document.createElement('span');
    span.className = 'chinese-character';
    span.setAttribute('data-char', character);
    span.textContent = character;
    
    // Style visible pour debug
    span.style.display = 'inline-block';
    span.style.margin = '0 2px';
    span.style.cursor = 'pointer';
    span.style.transition = 'all 0.2s ease';
    span.style.padding = '2px 4px';
    span.style.border = '1px dashed #ccc'; // Bordure visible pour debug
    span.style.borderRadius = '3px';
    
    // Log au hover
    span.addEventListener('mouseenter', (e) => {
      console.log('üê≠ HOVER sur caract√®re:', character);
      handleCharacterHover(e);
    });
    
    span.addEventListener('mouseleave', (e) => {
      console.log('üö™ LEAVE caract√®re:', character);
      handleCharacterLeave(e);
    });
    
    container.appendChild(span);
  });
  
  console.log('‚úÖ Caract√®res transform√©s');
}

// Gestionnaires simplifi√©s pour debug
function handleCharacterHover(event) {
  console.log('üéØ handleCharacterHover appel√©');
  const character = event.target.getAttribute('data-char');
  console.log('üî§ Caract√®re hover:', character);
  
  // Test simple sans API d'abord
  showSimpleModal(character, event.target);
}

function handleCharacterLeave(event) {
  console.log('üéØ handleCharacterLeave appel√©');
  hideCharacterModal();
}

// Modal simple pour test
function showSimpleModal(character, targetElement) {
  console.log('ü™ü showSimpleModal appel√©');
  
  if (!hoverModal) {
    hoverModal = document.createElement('div');
    hoverModal.className = 'character-modal';
    hoverModal.style.cssText = `
      position: fixed;
      background: white;
      border: 2px solid red; // Bordure rouge visible
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      max-width: 200px;
      font-size: 14px;
      display: none;
    `;
    document.body.appendChild(hoverModal);
    console.log('‚úÖ Modal cr√©√©');
  }

  const rect = targetElement.getBoundingClientRect();
  hoverModal.style.left = `${rect.left + window.scrollX}px`;
  hoverModal.style.top = `${rect.bottom + window.scrollY + 5}px`;
  hoverModal.style.display = 'block';
  
  hoverModal.innerHTML = `
    <div class="text-center">
      <div style="font-size: 24px; margin-bottom: 8px;">${character}</div>
      <div style="color: #e74c3c; font-weight: bold;">TEST - √áa marche !</div>
    </div>
  `;
  
  console.log('‚úÖ Modal affich√©');
}

let hoverModal = null;

function hideCharacterModal() {
  console.log('üéØ hideCharacterModal appel√©');
  if (hoverModal) {
    hoverModal.style.display = 'none';
    console.log('‚úÖ Modal cach√©');
  }
}

function showCard() {
  if (!words.length) return;
  const word = words[idx];
  if (!word) return;
  cardContainer.innerHTML = '';
  const newCard = createCardElement(word);
  cardContainer.appendChild(newCard);
}

// Navigation
prevBtn.onclick = ()=>{ idx=(idx-1+words.length)%words.length; showCard(); toggleView('card'); };
nextBtn.onclick = ()=>{ idx=(idx+1)%words.length; showCard(); toggleView('card'); };
window.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') prevBtn.click();
  else if(e.key==='ArrowRight') nextBtn.click();
});

// List view
function showList() {
  listBody.innerHTML = '';
  words.forEach((word,i)=>{
    const row=document.createElement('tr');
    row.innerHTML = `<td>${word.chinese}</td><td>${word.pinyin||''}</td><td>${word.english||''}</td>`;
    row.onclick = ()=>{
      idx=i;
      showCard();
      toggleView('card');
    };
    listBody.appendChild(row);
  });
}

function toggleView(view){
  if(view==='list'){
    // Afficher la liste
    listContainer.classList.remove('hidden'); 
    listContainer.classList.add('visible');
    
    // Cacher la carte
    cardContainer.classList.remove('visible'); 
    cardContainer.classList.add('hidden');
    
    // Cacher les boutons de navigation
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    
    // OPTIMISATION: Scroller au d√©but de la liste
    window.scrollTo({ top: listContainer.offsetTop, behavior: 'smooth' });

  } else {
    // Afficher la carte
    cardContainer.classList.remove('hidden'); 
    cardContainer.classList.add('visible');
    
    // Cacher la liste
    listContainer.classList.remove('visible'); 
    listContainer.classList.add('hidden');
    
    // Afficher les boutons de navigation
    prevBtn.style.display = 'inline-block';
    nextBtn.style.display = 'inline-block';
    
    // OPTIMISATION: Scroller au d√©but de la carte
    window.scrollTo({ top: cardContainer.offsetTop, behavior: 'smooth' });
  }
}


// Scroll pour passer de carte √† liste
window.addEventListener('wheel', (e)=>{
  if(e.deltaY > 30 && cardContainer.classList.contains('visible')) toggleView('list');
  else if(e.deltaY < -30 && listContainer.classList.contains('visible')) toggleView('card');
});


cardContainer.addEventListener('touchstart', e => {
  touchStartY = e.touches[0].clientY;
});

cardContainer.addEventListener('touchend', e => {
  const touchEndY = e.changedTouches[0].clientY;
  const deltaY = touchEndY - touchStartY;
  if(Math.abs(deltaY) > 30){ // seuil de swipe
    toggleView('list');
  }
});

// Modal
function openEdit(word){
  editId.value = word.id;
  editChinese.value = word.chinese;
  editPinyin.value = word.pinyin||'';
  editEnglish.value = word.english||'';
  editDescription.value = word.description||'';
  const modal = new bootstrap.Modal(editModal);
  modal.show();
}

// Edit submit
editForm.onsubmit = async (e)=>{
  e.preventDefault();
  const payload={
    chinese: editChinese.value,
    pinyin: editPinyin.value,
    english: editEnglish.value,
    description: editDescription.value
  };
  try{
    await fetch(`/update/${editId.value}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    words[idx]={...words[idx], ...payload};
    showCard();
    showList();
  }catch(err){alert("Update failed");}
  const bsModal = bootstrap.Modal.getInstance(editModal);
  if(bsModal) bsModal.hide();
};

//search a specific word in list
searchInput.addEventListener('input', () => {
  const query = searchInput.value.toLowerCase();
  document.querySelectorAll('#listBody tr').forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(query) ? '' : 'none';
  });
});

loadWords();

</script>
</body>
</html>
