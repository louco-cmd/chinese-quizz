<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Âä†Ê≤π! Quiz Caract√®res</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3b82f6"/>
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</head>
<body>

  <!-- M√™me navbar que le premier quiz -->
  <nav class="navbar navbar-expand-lg bg-primary navbar-dark px-2">
    <div class="container-fluid d-flex justify-content-between">
      <a class="navbar-brand cursor-pointer text-white fw-bold" onclick="window.location='/dashboard'">Âä†Ê≤πÔºÅ</a>
      <div class="d-flex">
        <button class="btn btn-outline-light w-auto" onclick="window.location='/dashboard'">Back to home</button>
      </div>
    </div>
  </nav>

  <!-- Container principal identique au premier quiz -->
  <div class="quiz-container container my-4 p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-6">

    <!-- Question -->
    <div id="quizQuestion" class="mb-3 fw-bold fs-5 text-center"></div>

    <!-- Formulaire du quiz -->
    <form id="quizForm" class="p-4 bg-light rounded gap-4 d-flex flex-column">
      <div id="quizFields" class="d-flex flex-wrap justify-content-center gap-2"></div>

      <!-- Boutons empil√©s verticalement -->
      <div class="d-flex flex-column gap-2">
        <button type="submit" id="checkBtn" class="btn btn-primary w-100">Soumettre</button>
        <button type="button" id="cancelQuiz" class="btn btn-light w-100">Annuler le quiz</button>
      </div>
    </form>

    <!-- R√©sultat -->
    <div id="quizResult" class="mt-3 text-center"></div>
    
    <!-- Score -->
    <div id="quizScore" class="mb-3 fw-bold text-center">‚úÖ 0 | ‚ùå 0</div>
    
  </div>

  <script>
    let quizWords = []; 
    let quizIdx = 0;
    let quizInputs = [];
    let correctCount = 0;
    let wrongCount = 0;

    const quizQuestion = document.getElementById('quizQuestion');
    const quizFields = document.getElementById('quizFields');
    const checkBtn = document.getElementById('checkBtn');
    const quizResult = document.getElementById('quizResult');
    const quizForm = document.getElementById('quizForm');
    const cancelQuiz = document.getElementById('cancelQuiz');
    const quizScore = document.getElementById('quizScore');

    // R√©cup√©rer le param√®tre "count" de l'URL
    const urlParams = new URLSearchParams(window.location.search);
    let quizCount = urlParams.get('count'); // "10" ou "all"

    if (quizCount !== "all") {
      quizCount = parseInt(quizCount);
    }

    // M√©lange un tableau
    function shuffleArray(arr) {
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Charger les mots et limiter leur nombre
    async function loadQuizWords(count = 10) {
      const res = await fetch('/liste');
      const mots = await res.json();

      if (!mots.length) {
        quizQuestion.textContent = '‚ö†Ô∏è Aucun mot disponible. Ajoutez des mots pour lancer le quiz.';
        checkBtn.style.display = 'none';
        return;
      }

      shuffleArray(mots);

      // Si count est "all" ou sup√©rieur au nombre de mots, utiliser tous les mots
      quizWords = (count === 'all' || count >= mots.length) ? mots : mots.slice(0, count);

      quizIdx = 0;
      correctCount = 0;
      wrongCount = 0;
      updateScore();
      checkBtn.style.display = 'inline-block';
      showQuizWord();
    }

    function showQuizWord() {
      quizFields.innerHTML = '';
      quizInputs = [];
      quizResult.textContent = '';

      if (quizIdx >= quizWords.length) {
        quizQuestion.textContent = 'üéâ Quiz termin√© !';
        checkBtn.style.display = 'none';
        setTimeout(() => { window.location.href = '/dashboard'; }, 2000);
        return;
      }

      const word = quizWords[quizIdx];
      quizQuestion.textContent = `Comment √©crire "${word.english}" en chinois ?`;

      // Cr√©er un input pour chaque caract√®re chinois
      for (let i = 0; i < word.chinese.length; i++) {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.maxLength = 1;
        inp.placeholder = '?';
        inp.className = 'form-control text-center';
        inp.style.width = '60px';
        inp.style.fontSize = '24px';
        
        inp.addEventListener('input', (e) => {
          if (e.target.value.length >= e.target.maxLength && quizInputs[i+1]){
            quizInputs[i+1].focus();
          }
        });
        
        quizFields.appendChild(inp);
        quizInputs.push(inp);
      }

      if (quizInputs[0]) {
        quizInputs[0].focus();
      }
    }

    function updateScore() {
      quizScore.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;
    }

    // V√©rification
    quizForm.onsubmit = (e) => {
      e.preventDefault();

      const userAnswer = quizInputs.map(inp => inp.value.trim()).join('');
      const correctAnswer = quizWords[quizIdx].chinese;

      if (userAnswer === correctAnswer) {
        quizResult.textContent = "‚úÖ Correct !";
        quizResult.className = "mt-3 text-center text-success fw-bold";
        correctCount++;
      } else {
        quizResult.textContent = `‚ùå Faux ! R√©ponse : ${correctAnswer}`;
        quizResult.className = "mt-3 text-center text-danger fw-bold";
        wrongCount++;
      }

      updateScore();
      quizIdx++;
      setTimeout(showQuizWord, 2000);
    };

    // Annuler le quiz
    cancelQuiz.onclick = () => {
      window.location.href = '/dashboard';
    };

    // Lancer le quiz
    document.addEventListener('DOMContentLoaded', () => {
      loadQuizWords(quizCount || 10);
    });

  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>