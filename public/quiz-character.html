<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Âä†Ê≤π! Quiz Caract√®res</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd"/>
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <style>/* Bottom Navigation Simple */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #dee2e6;
        z-index: 1000;
        padding: 8px 0;
    }

    /* Desktop - Ic√¥nes centr√©es */
    @media (min-width: 768px) {
        .nav-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .nav-item {
            flex: 0 0 auto; /* Pas de flex grow, taille automatique */
        }
    }

    /* Mobile - Layout √©tendu */
    @media (max-width: 767.98px) {
        .nav-container {
            display: flex;
            justify-content: space-around;
        }
        
        .nav-item {
            flex: 1;
        }
    }

    /* Style des items de navigation */
    .nav-link {
        color: #6c757d;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .nav-link:hover {
        background-color: #f8f9fa;
        color: #495057;
    }

    .nav-link.active {
        color: #0d6efd;
        background-color: #e3f2fd;
    }

    .nav-icon {
        font-size: 1.25rem;
    }

    .nav-text {
        font-size: 0.75rem;
    }

    /* D√©sactiv√© */
    .nav-link.disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .nav-link.disabled:hover {
        background-color: transparent;
        color: #6c757d;
    }</style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</head>
<body>

 <div class="d-flex justify-content-between align-items-center bg-primary text-white p-3">
  <span class="fs-3 fw-bold user-select-all" style="cursor: pointer;" onclick="window.location='/dashboard'">
    Âä†Ê≤πÔºÅ
  </span>
</div>

 <nav class="bottom-nav">
    <div class="container-fluid">
        <div class="nav-container">
            <!-- Home -->
            <div class="nav-item">
                <a href="/dashboard" class="nav-link active" data-page="dashboard" title="Dashboard">
                    <i class="bi bi-house-door-fill nav-icon"></i>
                    <span class="nav-text">Home</span>
                </a>
            </div>
            
            <!-- Collection -->
            <div class="nav-item">
                <a href="/collection" class="nav-link" data-page="collection" title="Ma Collection">
                    <i class="bi bi-journal-bookmark-fill nav-icon"></i>
                    <span class="nav-text">Collection</span>
                </a>
            </div>
            
            <!-- Account -->
            <div class="nav-item">
                <a href="/account.html" class="nav-link" data-page="account" title="Mon Compte">
                    <i class="bi bi-person-fill nav-icon"></i>
                    <span class="nav-text">Compte</span>
                </a>
            </div>
            
            <!-- Duel (d√©sactiv√© pour l'instant) -->
            <div class="nav-item">
                <a href="#" class="nav-link disabled" data-page="duel" title="Duel (Bient√¥t)">
                    <i class="bi bi-joystick nav-icon"></i>
                    <span class="nav-text">Duel</span>
                </a>
            </div>
        </div>
    </div>
  </nav>

  <div class="quiz-container container my-4 p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-6">

    <!-- Question -->
    <div id="quizQuestion" class="mb-3 fw-bold fs-5 text-center"></div>

    <!-- R√©sultat AU DESSUS des champs -->
    <div id="quizResult" class="mb-3 text-center fs-4 fw-bold"></div>

    <!-- Formulaire du quiz -->
    <form id="quizForm" class="p-4 bg-light rounded gap-4 d-flex flex-column">
      <div id="quizFields" class="d-flex flex-wrap justify-content-center gap-2"></div>

      <!-- Boutons - seulement "Soumettre" -->
      <div class="d-flex flex-column gap-2">
        <button type="submit" id="checkBtn" class="btn btn-primary w-100">Soumettre</button>
        <!-- ‚ùå Bouton Annuler supprim√© -->
      </div>
    </form>
    
    <!-- Score -->
    <div id="quizScore" class="mb-3 fw-bold text-center">‚úÖ 0 | ‚ùå 0</div>
    
  </div>

  <script>
    let quizWords = []; 
    let quizIdx = 0;
    let quizInputs = [];
    let correctCount = 0;
    let wrongCount = 0;
    let currentWord = null;
    let hasSecondChance = false;

    const quizQuestion = document.getElementById('quizQuestion');
    const quizFields = document.getElementById('quizFields');
    const checkBtn = document.getElementById('checkBtn');
    const quizResult = document.getElementById('quizResult');
    const quizForm = document.getElementById('quizForm');
    const quizScore = document.getElementById('quizScore');

    const urlParams = new URLSearchParams(window.location.search);
    let quizCount = urlParams.get('count');

    if (quizCount !== "all") {
      quizCount = parseInt(quizCount);
    }

    function shuffleArray(arr) {
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    async function loadQuizWords(count = 10) {
      const res = await fetch('/quiz-mots');
      const mots = await res.json();

      if (!mots.length) {
        quizQuestion.textContent = '‚ö†Ô∏è Aucun mot disponible. Ajoutez des mots pour lancer le quiz.';
        checkBtn.style.display = 'none';
        return;
      }

      shuffleArray(mots);
      quizWords = (count === 'all' || count >= mots.length) ? mots : mots.slice(0, count);

      quizIdx = 0;
      correctCount = 0;
      wrongCount = 0;
      hasSecondChance = false;
      updateScore();
      checkBtn.style.display = 'inline-block';
      showQuizWord();
    }

    function showQuizWord() {
      quizFields.innerHTML = '';
      quizInputs = [];
      quizResult.textContent = '';
      hasSecondChance = false;

      if (quizIdx >= quizWords.length) {
        quizQuestion.textContent = 'üéâ Quiz termin√© !';
        checkBtn.style.display = 'none';
        setTimeout(() => { window.location.href = '/dashboard'; }, 2000);
        return;
      }

      currentWord = quizWords[quizIdx];
      quizQuestion.textContent = `Comment √©crire "${currentWord.english}" en chinois ?`;

      // Cr√©er un input pour chaque caract√®re chinois
      for (let i = 0; i < currentWord.chinese.length; i++) {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.maxLength = 1;
        inp.placeholder = '?';
        inp.className = 'form-control text-center';
        inp.style.width = '60px';
        inp.style.fontSize = '24px';
        
        inp.addEventListener('input', (e) => {
          if (e.target.value.length >= e.target.maxLength && quizInputs[i+1]){
            quizInputs[i+1].focus();
          }
        });
        
        quizFields.appendChild(inp);
        quizInputs.push(inp);
      }

      if (quizInputs[0]) {
        quizInputs[0].focus();
      }
    }

    function updateScore() {
      quizScore.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;
    }

    // NOUVELLE LOGIQUE : Deuxi√®me chance
   quizForm.onsubmit = (e) => {
  e.preventDefault();

  const userAnswer = quizInputs.map(inp => inp.value.trim()).join('');
  const correctAnswer = currentWord.chinese;

  if (userAnswer === correctAnswer) {
    quizResult.textContent = "‚úÖ Correct !";
    quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
    
    if (!hasSecondChance) {
      correctCount++; // Bonne r√©ponse du premier coup
    }
    // Si hasSecondChance = true, on ne compte pas (d√©j√† compt√© comme erreur)
    
    updateScore();
    quizIdx++;
    setTimeout(showQuizWord, 1500);
    
  } else {
    if (!hasSecondChance) {
      // ‚úÖ PREMI√àRE ERREUR - ON COMPTE DIRECTEMENT
      wrongCount++; // üëà Compt√© comme mauvaise r√©ponse d√®s la 1√®re erreur
      updateScore();
      
      quizResult.textContent = `‚ùå Faux ! R√©ponse : ${correctAnswer}`;
      quizResult.className = "mb-3 text-center text-danger fw-bold fs-4";
      hasSecondChance = true;
      
      // Vider les champs pour permettre la correction d'apprentissage
      quizInputs.forEach(input => {
        input.value = '';
        input.style.border = '2px solid #dc3545';
        input.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
      });
      quizInputs[0].focus();
      
    } else {
      // Deuxi√®me tentative - juste pour l'apprentissage, d√©j√† compt√©
      quizResult.textContent = `‚úÖ Bien ! R√©ponse : ${correctAnswer}`;
      quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
      
      quizIdx++;
      setTimeout(showQuizWord, 1500);
    }
  }
};

    // Lancer le quiz
    document.addEventListener('DOMContentLoaded', () => {
      loadQuizWords(quizCount || 10);
    });
// Navigation System Simple
class SimpleNavigation {
    constructor() {
        this.currentPage = 'dashboard';
        this.init();
    }
    
    init() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = link.getAttribute('data-page');
                
                if (targetPage === this.currentPage || link.classList.contains('disabled')) {
                    return;
                }
                
                this.navigateTo(targetPage);
            });
        });
        
        this.showPage('dashboard');
    }
    
    navigateTo(page) {
        this.updateActiveNavItem(page);
        this.showPage(page);
        history.pushState({ page }, '', `#${page}`);
        this.currentPage = page;
    }
    
    updateActiveNavItem(page) {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
    
    showPage(page) {
        document.querySelectorAll('.page-content').forEach(content => {
            content.classList.add('d-none');
        });
        
        const activePage = document.getElementById(page);
        if (activePage) {
            activePage.classList.remove('d-none');
        }
    }
    
    handlePopState(event) {
        if (event.state && event.state.page) {
            this.navigateTo(event.state.page);
        }
    }
}
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>