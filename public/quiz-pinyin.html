<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chinese Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>

     <nav class="navbar navbar-expand-lg bg-primary navbar-dark">
  <div class="container-fluid d-flex justify-content-between">
    <!-- Titre -->
    <h1 class="navbar-brand text-white fw-bold" onclick="window.location='dashboard.html'">Vocabulary App </h1>
    <!-- Bouton -->
    <div class="d-flex">
      <button id="collectionBtn" class="btn btn-outline-light w-auto" onclick="window.location='dashboard.html'">Back to home</button>
    </div>
  </div>
</nav>

<div class="quiz-container container my-4 p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-6">

  <!-- Question -->
  <div id="quizQuestion" class="mb-3 fw-bold fs-5"></div>

  <!-- Formulaire du quiz -->
  <form id="quizForm" class="p-4 bg-light rounded gap-4 d-flex flex-column">
    <div id="quizFields" class="d-flex flex-row gap-2"></div>

    <!-- Boutons empil√©s verticalement -->
    <div class="d-flex flex-column gap-2">
      <button type="submit" id="checkBtn" class="btn btn-primary w-100">Soumettre</button>
      <button type="button" id="cancelQuiz" class="btn btn-light w-100">Annuler le quiz</button>
    </div>
  </form>

  <!-- R√©sultat -->
  <div id="quizResult" class="mt-3"></div>
  <!-- Score -->
<div id="quizScore" class="mb-3 fw-bold text-center">‚úÖ 0 | ‚ùå 0</div>
  
</div>


<script>
let quizWords = []; 
let quizIdx = 0;
let quizInputs = [];
let correctCount = 0; // ‚úÖ compteur bonnes r√©ponses
let wrongCount = 0;   // ‚ùå compteur mauvaises r√©ponses

const quizQuestion = document.getElementById('quizQuestion');
const quizFields = document.getElementById('quizFields');
const checkBtn = document.getElementById('checkBtn');
const quizResult = document.getElementById('quizResult');
const quizForm = document.getElementById('quizForm');
const cancelQuiz = document.getElementById('cancelQuiz');
const quizScore = document.getElementById('quizScore'); // affichage du score
// R√©cup√©rer le param√®tre "count" de l'URL
const urlParams = new URLSearchParams(window.location.search);
let quizCount = urlParams.get('count'); // "10" ou "all"

// Transformer en nombre si ce n‚Äôest pas "all"
if (quizCount !== "all") {
  quizCount = parseInt(quizCount);
}

// M√©lange un tableau
function shuffleArray(arr) {
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// Charger les mots et limiter leur nombre
async function loadQuizWords(count = 10) {
  const res = await fetch('/quiz-mots');
  const mots = await res.json();

  if (!mots.length) {
    quizQuestion.textContent = '‚ö†Ô∏è Aucun mot disponible. Ajoutez des mots pour lancer le quiz.';
    checkBtn.style.display = 'none';
    return;
  }

  shuffleArray(mots);

  // Si count est "all" ou sup√©rieur au nombre de mots, utiliser tous les mots
  quizWords = (count === 'all' || count >= mots.length) ? mots : mots.slice(0, count);

  quizIdx = 0;
  checkBtn.style.display = 'inline-block'; // au cas o√π il √©tait masqu√©
  showQuizWord();
}

function showQuizWord() {
  quizFields.innerHTML = '';
  quizInputs = [];
  quizResult.textContent = '';

  if (quizIdx >= quizWords.length) {
    quizQuestion.textContent = 'üéâ Quiz finished!';
    checkBtn.style.display = 'none';
    setTimeout(() => { window.location.href = '/'; }, 2000);
    return;
  }

  const word = quizWords[quizIdx];
  quizQuestion.textContent = `How do you say "${word.english}"?`;

  const answer = word.pinyin; 
  const answerParts = answer.split(' ');

  // Champs d'input c√¥te √† c√¥te
  answerParts.forEach((part, i) => {
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.maxLength = part.length;
    inp.placeholder = part.length + ' chars';
    inp.className = 'form-control text-center flex-fill'; // remplit l'espace
    inp.addEventListener('input', (e) => {
      if (e.target.value.length >= e.target.maxLength && quizInputs[i+1]){
        quizInputs[i+1].focus();
      }
    });
    quizFields.appendChild(inp);
    quizInputs.push(inp);
  });

  quizInputs[0].focus();
}

// Fonction utilitaire pour supprimer accents et mettre en minuscules
function normalizePinyin(str) {
  return str
    .normalize("NFD")                // d√©compose les lettres accentu√©es
    .replace(/[\u0300-\u036f]/g, "") // supprime les diacritiques
    .replace(/\s+/g, "")             // supprime tous les espaces
    .toLowerCase()
    .trim();
}

// V√©rification
quizForm.onsubmit = (e) => {
  e.preventDefault();

  const userAnswer = normalizePinyin(
    quizInputs.map(inp => inp.value).join("")
  );

  const correctAnswer = normalizePinyin(quizWords[quizIdx].pinyin);

  if (userAnswer === correctAnswer) {
    quizResult.textContent = "‚úÖ Correct!";
    correctCount++;
  } else {
    quizResult.textContent = `‚ùå Wrong! Correct: ${quizWords[quizIdx].pinyin}`;
    wrongCount++;
  }

  // Mettre √† jour le score affich√©
  quizScore.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;

  quizIdx++;
  setTimeout(showQuizWord, 2000);
};


// Annuler le quiz
cancelQuiz.onclick = () => {
  window.location.href = 'dashboard.html';
};

// Lancer le quiz
document.addEventListener('DOMContentLoaded', () => {
  const quizCountSelect = document.getElementById('quizCount');
  const count = quizCountSelect ? quizCountSelect.value : 10;
  loadQuizWords(count);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
