<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Âä†Ê≤πÔºÅCollection</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<style>
  #card-container,
  #list-container {
    transition: opacity 0.5s ease, transform 0.5s ease, max-height 0.5s ease-in-out;
  }

  .hidden {
    opacity: 0;
    transform: translateY(50px);
    pointer-events: none;
    /* Correction Cl√© 1 : Utilisation de max-height et overflow */
    max-height: 0;
    overflow: hidden;
    /* La visibilit√© permet d'assurer que l'√©l√©ment est compl√®tement ignor√© */
    visibility: hidden;
  }

  .visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
    /* Correction Cl√© 2 : Une grande valeur fixe pour la transition */
    max-height: 2000px; /* Doit √™tre plus grand que le contenu de la liste/carte */
    visibility: visible;
  }

  #listBody tr {
    cursor: pointer;
    transition: background-color 0.2s;
  }

  #listBody tr:hover {
    background-color: rgba(0, 123, 255, 0.1); /* light blue effect */
  }

  html,
  body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    margin-bottom: 45px; /* Pour √©viter que le contenu soit cach√© derri√®re la nav */
  }
  /* La couleur de fond de la carte */
  .card-custom-bg {
    background-color: #f7fcf7; /* Tr√®s clair */
    border: 1px solid #c8e6c9;
  }

  /* Classe pour le pinyin en grande taille */
  .fs-pinyin {
    font-size: 2.25rem; /* 36px */
  }

 .fs-chinese {
    font-size: 6.25rem; /* 100px */
    line-height: 1.2;
}

  /* Nouvelle classe pour les caract√®res chinois plus petits (4+ caract√®res) */
  .fs-chinese-small {
      font-size: 4.25rem; /* 84px */ /* Ajust√© √† votre demande */
      line-height: 1.2;
  }


  /* √âtiquette HSK verte */
  .hsk-tag-custom {
    background-color: white;
    color: #4CAF50; /* Vert sp√©cifique pour le texte */
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border-radius: 0.25rem; /* Bootstrap small radius */
  }

  /* Texte secondaire / Note de contexte */
  .text-context {
    color: #999;
    font-size: 0.875rem; /* 14px */
  }
  .text-box {
   min-height: 170px;
   align-content: center;
  }
   
</style>
  <!-- Ajoute ces lignes -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Ic√¥nes pour iOS -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- D√©tection PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</head>
<body>

 <div class="d-flex justify-content-between align-items-center bg-primary text-white p-3">
  <span class="fs-3 fw-bold user-select-all" style="cursor: pointer;" onclick="window.location='/dashboard'">
    Âä†Ê≤πÔºÅ
  </span>
</div>

  <!-- Navigation -->
  <%- include('partials/navbar', {currentPage: 'collection'}) %>

<section class="section d-flex flex-column align-items-center mt-4">
  <%- include('partials/voiceOn') %> 
  <div id="card-container" class="d-flex justify-content-center visible mb-2 position-relative"></div>

  <div id="list-container" class="container mt-4 hidden">
    <div class="mb-3" style="max-width: 400px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Looking for a word...">
    </div>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Chinese</th>
          <th>Pinyin</th>
          <th>English</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between w-100" style="max-width: 18rem;">
    <button id="prevBtn" class="btn btn-primary rounded-circle px-3 py-2">‚Äπ</button>
    <button id="nextBtn" class="btn btn-primary rounded-circle px-3 py-2">‚Ä∫</button>
  </div>
</section>

<!-- Modal Bootstrap -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Word</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editForm" class="p-3">
        <input type="hidden" id="editId" />
        <div class="mb-3"><label for="editChinese" class="form-label">Chinese</label><input type="text" class="form-control" id="editChinese" required></div>
        <div class="mb-3"><label for="editPinyin" class="form-label">Pinyin</label><input type="text" class="form-control" id="editPinyin"></div>
        <div class="mb-3"><label for="editEnglish" class="form-label">English</label><input type="text" class="form-control" id="editEnglish"></div>
        <div class="mb-3"><label for="editDescription" class="form-label">Description</label><textarea class="form-control" id="editDescription" rows="3"></textarea></div>
        <div class="text-end">
          <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/JS/global.js"></script>
<script>

  let words=[], idx=0;
  let touchStartY = 0;
  const cardContainer=document.getElementById('card-container');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const listContainer=document.getElementById('list-container');
  const listBody=document.getElementById('listBody');
  const searchInput = document.getElementById('searchInput');

  // modal
  const editModal=document.getElementById('editModal');
  const editForm=document.getElementById('editForm');
  const editId=document.getElementById('editId');
  const editChinese=document.getElementById('editChinese');
  const editPinyin=document.getElementById('editPinyin');
  const editEnglish=document.getElementById('editEnglish');
  const editDescription=document.getElementById('editDescription');

  // üéØ VARIABLES POUR LE SYST√àME DE HOVER
  let hoverModal = null;
  let cacheMots = null;
  let dernierFetch = 0;
  const CACHE_DURATION = 5 * 60 * 1000;

  // Load words
  async function loadWords(){
    const res=await fetch('/mes-mots'); 
    words=await res.json();
    if(!words.length){
      cardContainer.innerHTML='<p>No words yet.</p>';
      return;
    }
    idx=0; 
    showCard();
    showList();
  }

  // scroll control
  cardContainer.addEventListener('wheel', (e) => {
    const canScroll = cardContainer.scrollHeight > cardContainer.clientHeight;
    
    // Si la carte tient dans le conteneur, on autorise le toggle
    if(!canScroll && Math.abs(e.deltaY) > 30){
      toggleView('list');
    }
  });

//create card element
function createCardElement(word) {
    const card = document.createElement('div');
    card.classList.add('col', 'mb-4'); 
    
    const hskLevelDisplay = word.hsk || 'Street';
    const chineseFontSizeClass = (word.chinese && word.chinese.length >= 3) ? 'fs-chinese-small' : 'fs-chinese';

    card.innerHTML = `
      <div class="card card-custom-bg rounded-4 shadow-lg p-3 mx-auto" style="width: 320px; height: 500px; position: relative;">

          <div class="position-absolute top-0 end-0 mt-3 me-3">
              <span class="hsk-tag-custom py-1 px-2 border border-light">HSK : ${hskLevelDisplay}</span>
          </div>

          <!-- CARACT√àRE CHINOIS CLIQUABLE -->
          <div class="bg-white border rounded-3 p-4 py-2 mt-3 flex-grow-0">
              <div class="text-dark text-center text-box ${chineseFontSizeClass} chinese-clickable" 
                   data-word-id="${word.id}"
                   data-chinese-text="${word.chinese}"
                   title="Cliquer pour √©couter">
                  ${word.chinese}
              </div>
          </div>

          <div class="flex-grow-1 d-flex flex-column justify-content-between">
              <div>
                  <div class="fs-pinyin fw-bold text-dark mb-1">${word.pinyin || ''}</div>
                  <div class="fs-5 text-success mb-3">${word.english || 'No Translation'}</div>
                  <div class="pt-3 border-top border-light-subtle">
                      <div class="text-context">${word.description || 'No description provided.'}</div>
                  </div>
              </div>
              
              <!-- BOUTON AUDIO ADDITIONNEL -->
              <div class="d-flex justify-content-between align-items-center mt-auto">
                  <button class="btn btn-sm btn-outline-success btn-audio" 
                    data-text="${word.chinese}"
                    title="√âcouter la prononciation">
                    <i class="bi bi-volume-up"></i>  <!-- ‚Üê Picto uniquement -->
                  </button>
                  <a href="#" class="btn btn-link text-success edit-btn">‚úèÔ∏è Edit</a>
              </div>
          </div>
      </div>
    `;

    // Transforme les caract√®res chinois (ton code existant)
    const chineseContainer = card.querySelector('.chinese-clickable');
    if (chineseContainer && word.chinese) {
      transformChineseCharacters(word.chinese, chineseContainer);
    }

    // Gestion des √©v√©nements
    card.querySelector('.edit-btn').onclick = () => openEdit(word);
    
    return card;
}

// üéØ SYST√àME DE HOVER POUR CARACT√àRES
  function transformChineseCharacters(chineseWord, container) {
    if (!container || !chineseWord) {
        console.log('‚ö†Ô∏è Container ou mot chinois manquant:', { container: !!container, word: chineseWord });
        return;
    }

    // Ajout de la classe pour la s√©lection plus tard
    container.classList.add('chinese-container'); // Important !
    
    const characters = Array.from(chineseWord);
    container.setAttribute('data-original-word', chineseWord);
    
    console.log('üà∫ Transformation des caract√®res:', chineseWord);
    
    if (characters.length <= 1) {
        container.textContent = chineseWord;
        container.style.cursor = 'default';
        return;
    }
    
    container.innerHTML = '';
    
    characters.forEach((character) => {
        const span = document.createElement('span');
        span.className = 'chinese-character';
        span.setAttribute('data-char', character);
        span.textContent = character;
        
        // Ajout de logs pour debug
        span.addEventListener('mouseenter', (e) => {
            console.log('üîç Hover sur le caract√®re:', character);
            handleCharacterHover(e);
        });
        
        span.addEventListener('mouseleave', handleCharacterLeave);
        
        container.appendChild(span);
    });
}

let hoverTimeout = null;
let isHoveringModal = false;

function handleCharacterHover(event) {
    const character = event.target.getAttribute('data-char');
    console.log('üëÜ handleCharacterHover:', character);
    
    if (hoverTimeout) {
        clearTimeout(hoverTimeout);
        hoverTimeout = null;
    }
    
    // Correction importante ici
    const container = event.target.closest('.chinese-container');
    if (!container) {
        console.warn('‚ö†Ô∏è Container parent non trouv√©');
        return;
    }
    
    const originalWord = container.getAttribute('data-original-word');
    console.log('üìù Mot original:', originalWord);
    
    showCharacterModal(character, originalWord, event.target);
}

function handleCharacterLeave(event) {
  // üÜï V√©rifie qu'on ne soit pas en train de hover le modal lui-m√™me
  if (!isHoveringModal) {
    hoverTimeout = setTimeout(() => {
      if (hoverModal) {
        hoverModal.style.display = 'none';
      }
    }, 150); // üÜï L√©g√®rement plus long pour plus de confort
  }
}

function showCharacterModal(character, originalWord, targetElement) {
    console.log('üîç showCharacterModal:', { character, originalWord });
    
    if (!targetElement) {
        console.error('‚ùå √âl√©ment cible manquant');
        return;
    }

    // Cr√©ation du modal avec dimensions fixes et style Bootstrap
    if (!hoverModal) {
        hoverModal = document.createElement('div');
        hoverModal.className = 'character-modal card border-0';
        hoverModal.style.cssText = `
            position: fixed;
            width: 180px;          /* Largeur fixe */
            height: auto;          /* Hauteur adaptative */
            z-index: 10000;
            display: none;
            transform: translateX(-50%); /* Pour le centrage horizontal */
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        `;
        document.body.appendChild(hoverModal);
    }

    // Positionnement centr√© sous le caract√®re
    const rect = targetElement.getBoundingClientRect();
    const centerX = rect.left + (rect.width / 2);
    
    hoverModal.style.left = `${centerX}px`;
    hoverModal.style.top = `${rect.bottom + window.scrollY + 8}px`;
    hoverModal.style.display = 'block';
    requestAnimationFrame(() => hoverModal.classList.add('visible'));

    // Template Bootstrap avec loading state
    hoverModal.innerHTML = `
        <div class="card-body p-3">
            <div class="text-center">
                <div class="mb-2">
                    <span class="fs-3 fw-bold text-dark">${character}</span>
                </div>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Mise √† jour de fetchCharacterData pour le nouveau design
async function fetchCharacterData(character) {
    try {
        // D'abord chercher dans les mots d√©j√† charg√©s (words)
        let caractereExact = words.find(mot => 
            mot && mot.chinese && mot.chinese.includes(character)
        );

        // Si pas trouv√© dans les mots de l'utilisateur, chercher dans tous les mots
        if (!caractereExact && (!cacheMots || Date.now() - dernierFetch > CACHE_DURATION)) {
            console.log('üîÑ Caract√®re non trouv√© localement, chargement de tous les mots...');
            const response = await fetch('/api/tous-les-mots');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            cacheMots = await response.json();
            dernierFetch = Date.now();
            
            // Chercher dans le cache complet
            caractereExact = cacheMots.find(mot => 
                mot && mot.chinese && mot.chinese.includes(character)
            );
        }

        if (!caractereExact) {
            throw new Error('Caract√®re non trouv√©');
        }

        // Mise √† jour du modal avec les donn√©es trouv√©es
        if (hoverModal) {
            hoverModal.innerHTML = `
                <div class="card-body p-3">
                    <div class="text-center">
                        <div class="mb-2">
                            <span class="fs-3 fw-bold text-dark">${character}</span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                ${caractereExact.pinyin || 'N/A'}
                            </span>
                        </div>
                        <div class="small text-secondary mb-2">
                            ${caractereExact.english || 'No translation'}
                        </div>
                        ${caractereExact.hsk ? `
                            <div class="mt-2 pt-2 border-top">
                                <span class="badge bg-success-subtle text-success">
                                    HSK ${caractereExact.hsk}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Erreur fetchCharacterData:', error);
        if (hoverModal) {
            hoverModal.innerHTML = `
                <div class="card-body p-3">
                    <div class="text-center">
                        <div class="mb-2">
                            <span class="fs-3 fw-bold text-dark">${character}</span>
                        </div>
                        <div class="text-muted small">
                            Caract√®re non trouv√©
                        </div>
                    </div>
                </div>
            `;
        }
    }
}

  function showCard() {
    if (!words.length) return;
    const word = words[idx];
    if (!word) return;
    cardContainer.innerHTML = '';
    const newCard = createCardElement(word);
    cardContainer.appendChild(newCard);
  }

  // Navigation
  prevBtn.onclick = ()=>{ idx=(idx-1+words.length)%words.length; showCard(); toggleView('card'); };
  nextBtn.onclick = ()=>{ idx=(idx+1)%words.length; showCard(); toggleView('card'); };

  window.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft') prevBtn.click();
    else if(e.key==='ArrowRight') nextBtn.click();
  });

  // List view
  function showList() {
    listBody.innerHTML = '';
    words.forEach((word,i)=>{
      const row=document.createElement('tr');
      row.innerHTML = `<td>${word.chinese}</td><td>${word.pinyin||''}</td><td>${word.english||''}</td>`;
      row.onclick = ()=>{
        idx=i;
        showCard();
        toggleView('card');
      };
      listBody.appendChild(row);
    });
  }

  function toggleView(view){
    if(view==='list'){
      listContainer.classList.remove('hidden'); 
      listContainer.classList.add('visible');
      cardContainer.classList.remove('visible'); 
      cardContainer.classList.add('hidden');
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      window.scrollTo({ top: listContainer.offsetTop, behavior: 'smooth' });
    } else {
      cardContainer.classList.remove('hidden'); 
      cardContainer.classList.add('visible');
      listContainer.classList.remove('visible'); 
      listContainer.classList.add('hidden');
      prevBtn.style.display = 'inline-block';
      nextBtn.style.display = 'inline-block';
      window.scrollTo({ top: cardContainer.offsetTop, behavior: 'smooth' });
    }
  }

  // Scroll pour passer de carte √† liste
  window.addEventListener('wheel', (e)=>{
    if(e.deltaY > 30 && cardContainer.classList.contains('visible')) toggleView('list');
    else if(e.deltaY < -30 && listContainer.classList.contains('visible')) toggleView('card');
  });

  cardContainer.addEventListener('touchstart', e => {
    touchStartY = e.touches[0].clientY;
  });

  cardContainer.addEventListener('touchend', e => {
    const touchEndY = e.changedTouches[0].clientY;
    const deltaY = touchEndY - touchStartY;
    if(Math.abs(deltaY) > 30){
      toggleView('list');
    }
  });

  // Modal
  function openEdit(word){
    editId.value = word.id;
    editChinese.value = word.chinese;
    editPinyin.value = word.pinyin||'';
    editEnglish.value = word.english||'';
    editDescription.value = word.description||'';
    const modal = new bootstrap.Modal(editModal);
    modal.show();
  }

  // Edit submit
  editForm.onsubmit = async (e)=>{
    e.preventDefault();
    const payload={
      chinese: editChinese.value,
      pinyin: editPinyin.value,
      english: editEnglish.value,
      description: editDescription.value
    };
    try{
      await fetch(`/update/${editId.value}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      words[idx]={...words[idx], ...payload};
      showCard();
      showList();
    }catch(err){alert("Update failed");}
    const bsModal = bootstrap.Modal.getInstance(editModal);
    if(bsModal) bsModal.hide();
  };

  //search a specific word in list
  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    document.querySelectorAll('#listBody tr').forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(query) ? '' : 'none';
    });
  });

  loadWords();
// Navigation System Simple
class SimpleNavigation {
    constructor() {
        this.currentPage = 'dashboard';
        this.init();
    }
    
    init() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = link.getAttribute('data-page');
                
                if (targetPage === this.currentPage || link.classList.contains('disabled')) {
                    return;
                }
                
                this.navigateTo(targetPage);
            });
        });
        
        this.showPage('dashboard');
    }
    
    navigateTo(page) {
        this.updateActiveNavItem(page);
        this.showPage(page);
        history.pushState({ page }, '', `#${page}`);
        this.currentPage = page;
    }
    
    updateActiveNavItem(page) {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
    
    showPage(page) {
        document.querySelectorAll('.page-content').forEach(content => {
            content.classList.add('d-none');
        });
        
        const activePage = document.getElementById(page);
        if (activePage) {
            activePage.classList.remove('d-none');
        }
    }
    
    handlePopState(event) {
        if (event.state && event.state.page) {
            this.navigateTo(event.state.page);
        }
    }
}
// D√©tection automatique de la page active
function setActiveNavItem() {
    const path = window.location.pathname;
    
  document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        // Active si le data-page correspond √† l'URL
        if (path.includes(link.getAttribute('data-page'))) {
            link.classList.add('active');
        }
    });
}
// Appeler au chargement
document.addEventListener('DOMContentLoaded', setActiveNavItem);

</script>

<style>
    /* ... existing styles ... */
    
    .character-modal {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
    }
    
    .character-modal.visible {
        opacity: 1;
    }
</style>
</body>
</html>
