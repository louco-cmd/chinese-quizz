<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duel - Âä†Ê≤π!</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    .syllable-input {
      min-width: 100px;
      text-align: center;
    }

    .chinese-character {
      cursor: help;
    }

    .card-custom-bg {
      background: #FFF4F2;
      border: 1px solid #FDA297;
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>
  <%- include('partials/navbar', {currentPage: 'duels'}) %>

  <div class="container my-4">
    <!-- Quiz container (same as quiz page) -->
    <div class="quiz-container p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-8 mx-auto">
      
      <!-- Duel header - full width, light gray, minimal -->
      <div class="bg-light border-bottom py-2 mb-4">
        <div class="container d-flex justify-content-between align-items-center">
          <span class="fw-semibold text-secondary">‚öîÔ∏è Duel vs <span class="text-dark"><%= duel.challenger_id === user.id ? duel.opponent_name : duel.challenger_name %></span></span>
          <span class="badge bg-white text-dark border"><%= duel.duel_type === 'classic' ? 'Classic' : 'AA Match' %></span>
        </div>
      </div>

      <!-- Question -->
      <div id="quizQuestion" class="mb-4 fw-bold fs-3 text-center"></div>

      <!-- Result alert -->
      <div id="quizResult" class="alert mb-4 text-center" style="display: none;"></div>

      <!-- Form -->
      <form id="quizForm" class="p-4 bg-white rounded gap-4 d-flex flex-column">
        <div id="quizFields" class="d-flex flex-wrap justify-content-center gap-2 mb-3"></div>

        <!-- Single button -->
        <div class="d-flex flex-column gap-2">
          <button type="submit" id="checkBtn" class="btn btn-primary w-100 btn-lg">
            <i class="bi bi-send-check me-2"></i>Submit
          </button>
        </div>
      </form>

      <!-- Score and progress -->
      <div class="row mt-4">
        <div class="col-12 col-md-6">
          <div id="quizScore" class="fw-bold text-center fs-5">‚úÖ 0 | ‚ùå 0</div>
        </div>
        <div class="col-12 col-md-6">
          <div id="quizProgress" class="text-muted fw-medium text-center">Question 1/<%= quizData.words.length %></div>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="progress mt-3">
        <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/saveQuiz.js"></script>
  <script src="/js/global.js"></script>
  <script src="/js/tts-chinese.js"></script>
  <script src="/js/card-function.js"></script>
  <script>
    // Duel data
    const duelId = <%= duel.id %>;
    const quizData = <%- JSON.stringify(quizData) %>;

    // Quiz variables
    let quizWords = quizData.words || [];
    let quizIdx = 0;
    let quizInputs = [];
    let correctCount = 0;
    let wrongCount = 0;
    let currentWord = null;
    let hasSecondChance = false;
    let quizEnded = false;

    window.quizWords = quizWords;

    // DOM elements
    const quizQuestion = document.getElementById('quizQuestion');
    const quizFields = document.getElementById('quizFields');
    const checkBtn = document.getElementById('checkBtn');
    const quizResult = document.getElementById('quizResult');
    const quizForm = document.getElementById('quizForm');
    const quizScore = document.getElementById('quizScore');
    const quizProgress = document.getElementById('quizProgress');
    const progressBar = document.getElementById('progressBar');

    // Helper to show character card (uses external function if available, otherwise fallback)
    const showCharacterCard = (() => {
      // If the global function from card-function.js exists, use it
      if (typeof window.showCharacterCard === 'function') {
        return window.showCharacterCard;
      }
      // Otherwise provide a simple fallback
      return function(word) {
        const card = document.createElement('div');
        card.className = 'card card-custom-bg rounded-4 shadow-sm p-3 mb-3 mx-auto';
        card.style.cssText = 'width: 280px; max-width: 100%; background: #FFF4F2; border: 1px solid #FDA297;';
        card.id = 'character-card-feedback';

        const hskLevelDisplay = word.hsk || 'Street';
        const chineseFontSizeClass = word.chinese && word.chinese.length >= 3 ? 'fs-2' : 'fs-1';

        card.innerHTML = `
          <div class="card-body text-center p-0">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge bg-secondary">HSK ${hskLevelDisplay}</span>
              <button class="btn btn-sm btn-outline-primary btn-audio" 
                      data-text="${word.chinese}"
                      title="Listen pronunciation">
                <i class="bi bi-volume-up"></i>
              </button>
            </div>
            <div class="bg-white border rounded-3 p-3">
              <div class="${chineseFontSizeClass} text-dark chinese-clickable" 
                   data-word-id="${word.id}"
                   data-chinese-text="${word.chinese}"
                   style="min-height: 60px; display: flex; align-items: center; justify-content: center;">
                ${word.chinese}
              </div>
            </div>
            <div class="mt-2 text-muted small">${word.pinyin}</div>
          </div>
        `;

        quizForm.parentNode.insertBefore(card, quizForm);

        const audioBtn = card.querySelector('.btn-audio');
        if (audioBtn) {
          audioBtn.addEventListener('click', function() {
            const text = this.getAttribute('data-text');
            if (window.textToSpeech) {
              window.textToSpeech(text, 'zh-CN');
            } else if ('speechSynthesis' in window) {
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.lang = 'zh-CN';
              utterance.rate = 0.8;
              speechSynthesis.speak(utterance);
            }
          });
        }

        if (window.transformChineseCharacters) {
          const chineseContainer = card.querySelector('.chinese-clickable');
          if (chineseContainer && word.chinese) {
            window.transformChineseCharacters(word.chinese, chineseContainer);
          }
        }
      };
    })();

    function hideCharacterCard() {
      const card = document.getElementById('character-card-feedback');
      if (card) card.remove();
    }

    // Init
    document.addEventListener('DOMContentLoaded', function() {
      if (quizWords.length === 0) {
        quizQuestion.textContent = '‚ùå Error: no words in this duel';
        checkBtn.style.display = 'none';
        return;
      }
      shuffleArray(quizWords);
      startQuiz();
    });

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function startQuiz() {
      quizIdx = 0;
      correctCount = 0;
      wrongCount = 0;
      hasSecondChance = false;
      quizEnded = false;
      updateScore();
      updateProgress();
      enableSubmitButton();
      showQuizWord();
    }

    function showQuizWord() {
      quizFields.innerHTML = '';
      quizInputs = [];
      quizResult.style.display = 'none';
      hasSecondChance = false;
      hideCharacterCard();
      enableSubmitButton();

      if (quizIdx >= quizWords.length) {
        endQuiz();
        return;
      }

      currentWord = quizWords[quizIdx];
      updateProgress();
      showPinyinQuestion();

      if (quizInputs.length > 0) quizInputs[0].focus();
    }

    function showPinyinQuestion() {
      quizQuestion.textContent = `How to say "${currentWord.english}" in pinyin?`;

      const syllables = currentWord.pinyin.split(' ');
      syllables.forEach((syllable, index) => {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'd-flex flex-column align-items-center';

        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'form-control syllable-input mb-1';
        inp.placeholder = `${syllable.length} letters`;
        inp.maxLength = syllable.length;

        inp.addEventListener('input', (e) => {
          if (e.target.value.length >= e.target.maxLength && quizInputs[index + 1]) {
            quizInputs[index + 1].focus();
          }
        });

        inputGroup.appendChild(inp);
        quizFields.appendChild(inputGroup);
        quizInputs.push(inp);
      });
    }

    function updateProgress() {
      quizProgress.textContent = `Question ${quizIdx + 1}/${quizWords.length}`;
      const progress = (quizIdx / quizWords.length) * 100;
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${Math.round(progress)}%`;
    }

    function updateScore() {
      quizScore.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;
    }

    function normalizePinyin(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "")
        .toLowerCase()
        .trim();
    }

    function disableSubmitButton() {
      checkBtn.disabled = true;
      checkBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Loading...';
      checkBtn.classList.add('disabled');
    }

    function enableSubmitButton() {
      checkBtn.disabled = false;
      checkBtn.innerHTML = '<i class="bi bi-send-check me-2"></i>Submit';
      checkBtn.classList.remove('disabled');
    }

    quizForm.onsubmit = (e) => {
      e.preventDefault();
      disableSubmitButton();

      const userAnswer = normalizePinyin(quizInputs.map(inp => inp.value).join(""));
      const correctAnswer = normalizePinyin(currentWord.pinyin);

      if (userAnswer === correctAnswer) {
        quizResult.textContent = "‚úÖ Correct!";
        quizResult.className = "alert alert-success";
        quizResult.style.display = 'block';

        if (!hasSecondChance) {
          correctCount++;
        }
        updateScore();

        quizIdx++;
        setTimeout(() => {
          if (!quizEnded) {
            hideCharacterCard();
            showQuizWord();
          }
        }, 1200);
      } else {
        if (!hasSecondChance) {
          wrongCount++;
          updateScore();

          showCharacterCard(currentWord);

          hasSecondChance = true;

          quizInputs.forEach(input => {
            input.value = '';
            input.style.border = '2px solid #dc3545';
            input.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
          });
          quizInputs[0].focus();

          quizResult.textContent = "Oups, try again";
          quizResult.className = "alert alert-danger";
          quizResult.style.display = 'block';

          enableSubmitButton();
        } else {
          quizResult.textContent = `The correct answer was: ${currentWord.pinyin}`;
          quizResult.className = "alert alert-warning";
          quizResult.style.display = 'block';

          quizIdx++;
          setTimeout(() => {
            if (!quizEnded) {
              hideCharacterCard();
              showQuizWord();
            }
          }, 1200);
        }
      }
    };

    function endQuiz() {
      quizEnded = true;
      hideCharacterCard();

      quizQuestion.textContent = 'üéâ Duel finished!';
      quizResult.textContent = `Final score: ${correctCount}/${quizWords.length}`;
      quizResult.className = "alert alert-success text-center fs-4";
      quizResult.style.display = 'block';
      checkBtn.style.display = 'none';
      quizFields.innerHTML = '';
      progressBar.style.width = '100%';
      progressBar.textContent = '100%';

      submitDuelScore(correctCount);
    }

    async function submitDuelScore(score) {
      console.log('üéØ Submitting score:', {
        duelId,
        score
      });
      try {
        const response = await fetch(`/api/duels/${duelId}/submit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            score
          })
        });

        const result = await response.json();
        if (result.success) {
          if (result.duel_completed) {
            setTimeout(() => {
              window.location.href = '/duels?message=duel_completed';
            }, 2000);
          } else {
            setTimeout(() => {
              window.location.href = '/duels?message=score_submitted';
            }, 2000);
          }
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        console.error('‚ùå Network error:', error);
        alert('Network error: ' + error.message);
      }
    }
  </script>
</body>

</html>