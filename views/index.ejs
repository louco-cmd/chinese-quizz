<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Âä†Ê≤πÔºÅ - Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Google One Tap -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    .login-container {
      min-height: 100vh;
      background-color: #f8f9fa;
    }

    .login-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .btn-social {
      padding: 14px 20px;
      font-weight: 500;
      border: 1px solid #dee2e6;
      transition: all 0.2s ease;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-social:hover {
      background-color: #0d6efd;
      border-color: #adb5bd;
      color: white;
    }

    .app-title {
      font-size: 3rem;
      font-weight: bold;
      color: #0d6efd;
      margin-bottom: 0.5rem;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 2rem 0;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid #dee2e6;
    }

    .divider-text {
      padding: 0 1rem;
      color: #6c757d;
      font-size: 0.875rem;
      background: white;
    }

    .social-icon {
      width: 20px;
      margin-right: 12px;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    .fade-out {
      animation: fadeOut 0.3s ease-out;
      opacity: 0;
      pointer-events: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }

    @media (max-width: 576px) {
      .login-card {
        margin: 1rem;
        padding: 2rem 1.5rem !important;
      }

      .app-title {
        font-size: 2.5rem;
      }

      .btn-social {
        padding: 12px 16px;
        height: 50px;
      }
    }
  </style>
</head>

<body>

  <% if (error==='auth_failed' ) { %>
    <div class="alert alert-danger">Authentication error. Please try again.</div>
    <% } %>

      <div class="login-container d-flex align-items-center justify-content-center py-4">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6 col-xl-5">
              <div class="card login-card p-4 p-md-5">
                <!-- Header -->
                <div class="text-center mb-4">
                  <h1 class="app-title">Âä†Ê≤π!</h1>
                  <p class="text-muted mb-0">Learn Chinese in the real world. Collect your words, test yourself,
                    challenge your friends and much more.</p>
                </div>

                <!-- Email verification message (hidden by default) -->
                <div id="verification-message" class="alert alert-info d-none fade-in">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-envelope-check me-2 fs-4"></i>
                    <div>
                      <strong>Check your email!</strong>
                      <p class="mb-0">We've sent a verification link to your email address.</p>
                      <small>You will be redirected to the home page in <span id="countdown">5</span> seconds...</small>
                    </div>
                  </div>
                </div>

                <!-- Main content -->
                <div id="main-content">
                  <!-- Google button section -->
                  <div id="google-section" class="d-grid gap-3">
                    <button onclick="initiateManualAuth()"
                      class="btn btn-social btn-outline-primary d-flex align-items-center justify-content-center">
                      <i class="bi bi-google social-icon"></i>
                      <span>Continue with Google</span>
                    </button>
                  </div>
                  
                  <!-- Divider (hidden when Google button is hidden) -->
                  <div id="divider-section" class="divider">
                    <span class="divider-text">or</span>
                  </div>

                  <!-- Email authentication form -->
                  <form id="email-auth-form" class="mt-1">
                    <!-- Email input (always visible) -->
                    <div class="mb-3">
                      <input type="email" id="email-input" class="form-control" placeholder="Email address" required />
                    </div>

                    <!-- Password section (hidden initially) -->
                    <div id="password-section" class="d-none fade-in">
                      <div class="mb-3">
                        <input type="password" id="password-field" class="form-control" placeholder="Password" />
                        <small id="password-help" class="text-muted mt-1 d-block">
                          Min. 8 characters, 1 uppercase, 1 number
                        </small>
                      </div>

                      <!-- Additional info for signup -->
                      <div id="signup-info" class="d-none fade-in">
                        <div class="alert alert-light border">
                          <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            After signing up, you'll receive a verification email to activate your account.
                          </small>
                        </div>
                      </div>

                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <button type="submit" id="submit-btn" class="btn btn-primary flex-grow-1 me-2">
                          Continue
                        </button>
                        <button type="button" id="cancel-btn" class="btn btn-outline-secondary">
                          Cancel
                        </button>
                      </div>
                    </div>

                    <!-- Forgot password link (only for login) -->
                    <div id="forgot-password-link" class="text-center mt-2 d-none">
                      <a href="/forgot-password" class="text-decoration-none">Forgot password?</a>
                    </div>

                    <!-- Continue button for email step -->
                    <button type="submit" id="email-continue-btn" class="btn btn-primary w-100">
                      Continue with Email
                    </button>

                    <div id="email-auth-error" class="text-danger small mt-2 d-none">
                      Authentication failed
                    </div>
                  </form>
                </div>

                <!-- Footer -->
                <div class="text-center mt-4 pt-3 border-top">
                  <small class="text-muted">
                    By continuing, you agree to our
                    <a href="#" class="text-decoration-none">Terms of Service</a>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        // DOM Elements
        const emailForm = document.getElementById('email-auth-form');
        const emailInput = document.getElementById('email-input');
        const passwordSection = document.getElementById('password-section');
        const passwordField = document.getElementById('password-field');
        const signupInfo = document.getElementById('signup-info');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const emailContinueBtn = document.getElementById('email-continue-btn');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const emailError = document.getElementById('email-auth-error');
        const mainContent = document.getElementById('main-content');
        const verificationMessage = document.getElementById('verification-message');
        const countdownSpan = document.getElementById('countdown');
        const googleSection = document.getElementById('google-section');
        const dividerSection = document.getElementById('divider-section');

        // State
        let authStep = 'email'; // 'email', 'login', or 'signup'
        let currentEmail = null;

        // Reset form to initial state
        function resetForm() {
          authStep = 'email';
          currentEmail = null;
          passwordSection.classList.add('d-none');
          signupInfo.classList.add('d-none');
          forgotPasswordLink.classList.add('d-none');
          emailContinueBtn.classList.remove('d-none');
          emailError.classList.add('d-none');
          passwordField.value = '';
          emailInput.disabled = false;
          emailInput.focus();
          
          // Show Google button and divider again
          googleSection.classList.remove('d-none');
          dividerSection.classList.remove('d-none');
        }

        // Hide form and show verification message
        function showVerificationMessage() {
          // Fade out the form
          mainContent.classList.add('fade-out');
          
          // Wait for fade out animation
          setTimeout(() => {
            mainContent.classList.add('d-none');
            mainContent.classList.remove('fade-out');
            
            // Show verification message
            verificationMessage.classList.remove('d-none');
            
            // Start countdown
            let countdown = 5;
            countdownSpan.textContent = countdown;
            
            const countdownInterval = setInterval(() => {
              countdown--;
              countdownSpan.textContent = countdown;
              
              if (countdown <= 0) {
                clearInterval(countdownInterval);
                // Reset everything and show initial form
                verificationMessage.classList.add('d-none');
                mainContent.classList.remove('d-none');
                resetForm();
              }
            }, 1000);
          }, 300); // Match fade-out animation duration
        }

        // Handle email form submission
        emailForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          emailError.classList.add('d-none');

          const email = emailInput.value.trim();

          // Email validation
          if (!email) {
            emailError.textContent = 'Please enter your email address';
            emailError.classList.remove('d-none');
            return;
          }

          // STEP 1 ‚Äî Check email
          if (authStep === 'email') {
            try {
              const res = await fetch('/auth/check-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
              });

              const data = await res.json();
              currentEmail = email;

              if (data.step === 'login') {
                // Existing user - show password field for login
                authStep = 'login';
                emailInput.disabled = true;
                emailContinueBtn.classList.add('d-none');
                passwordSection.classList.remove('d-none');
                signupInfo.classList.add('d-none');
                forgotPasswordLink.classList.remove('d-none');
                passwordField.placeholder = 'Enter your password';
                passwordField.focus();
                
                // Update submit button text
                submitBtn.textContent = 'Sign In';
                
                // Hide Google button and divider to focus on login
                googleSection.classList.add('d-none');
                dividerSection.classList.add('d-none');
                
              } else if (data.step === 'signup') {
                // New user - show password field for signup
                authStep = 'signup';
                emailInput.disabled = true;
                emailContinueBtn.classList.add('d-none');
                passwordSection.classList.remove('d-none');
                signupInfo.classList.remove('d-none');
                forgotPasswordLink.classList.add('d-none');
                passwordField.placeholder = 'Create a password';
                passwordField.focus();
                
                // Update submit button text
                submitBtn.textContent = 'Create Account';
                
                // Hide Google button and divider to focus on signup
                googleSection.classList.add('d-none');
                dividerSection.classList.add('d-none');
                
              } else if (data.step === 'google_only') {
                // Google-only account
                emailError.textContent = 'This email is associated with a Google account. Please sign in with Google.';
                emailError.classList.remove('d-none');
              }

            } catch (err) {
              console.error(err);
              emailError.textContent = 'Something went wrong. Please try again.';
              emailError.classList.remove('d-none');
            }
            return;
          }

          // STEP 2 ‚Äî Login or Signup
          const password = passwordField.value.trim();
          
          if (!password) {
            emailError.textContent = 'Please enter your password';
            emailError.classList.remove('d-none');
            return;
          }

          // Password validation for signup
          if (authStep === 'signup') {
            const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
              emailError.textContent = 'Password: min 8 characters, 1 uppercase, 1 number';
              emailError.classList.remove('d-none');
              return;
            }
          }

          const endpoint = authStep === 'login' 
            ? '/auth/login-basic' 
            : '/auth/signup-basic';

          try {
            // Show loading state on button
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: currentEmail,
                password
              })
            });

            const data = await res.json();

            // Restore button state
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;

            if (data.success) {
              if (authStep === 'signup') {
                // For signup, fade out form and show verification message
                showVerificationMessage();
              } else {
                // For login, redirect to dashboard
                window.location.href = data.redirect || '/dashboard';
              }
            } else {
              emailError.textContent = data.error || 'Authentication failed';
              emailError.classList.remove('d-none');
            }

          } catch (err) {
            console.error(err);
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.textContent = authStep === 'login' ? 'Sign In' : 'Create Account';
            emailError.textContent = 'Server error, please try again later';
            emailError.classList.remove('d-none');
          }
        });

        // Cancel button handler
        cancelBtn.addEventListener('click', resetForm);

        // Allow editing email by clicking on it when disabled
        emailInput.addEventListener('click', () => {
          if (emailInput.disabled && authStep !== 'email') {
            resetForm();
          }
        });

        // Restore Google button functionality
        function initiateManualAuth() {
          // Show loading state
          const googleBtn = googleSection.querySelector('button');
          const originalText = googleBtn.innerHTML;
          googleBtn.disabled = true;
          googleBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Redirecting...';
          
          // Redirect to Google OAuth
          window.location.href = '/auth/google';
        }

        // Alternative: if using popup window for Google auth
        /*
        function initiateManualAuth() {
          const width = 500;
          const height = 600;
          const left = (window.innerWidth - width) / 2;
          const top = (window.innerHeight - height) / 2;
          
          const popup = window.open(
            '/auth/google',
            'GoogleAuth',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
          );
          
          // Check for popup closure/redirection
          const checkPopup = setInterval(() => {
            if (popup.closed) {
              clearInterval(checkPopup);
              window.location.reload(); // Reload to update auth state
            }
          }, 500);
        }
        */

        // Focus on email input on page load
        document.addEventListener('DOMContentLoaded', () => {
          emailInput.focus();
        });

        // Remplacez votre fonction handleGoogleSignIn par ceci :
        function handleGoogleSignIn(response) {
          console.log('üîê Google One Tap response received');
          
          // Show loading state
          showStatus('Signing in with Google...', 'info');
          
          // Important: Use absolute URL if needed
          const backendUrl = window.location.origin;
          
          fetch(`${backendUrl}/auth/google/one-tap`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              // Important for CORS
              'Accept': 'application/json'
            },
            credentials: 'include', // ‚úÖ Important for cookies/sessions
            body: JSON.stringify({ 
              credential: response.credential,
              g_csrf_token: response.clientId // Optional CSRF token
            })
          })
          .then(async (res) => {
            console.log('Response status:', res.status);
            
            if (!res.ok) {
              const text = await res.text();
              console.error('Response text:', text);
              throw new Error(`HTTP ${res.status}: ${text}`);
            }
            
            return res.json();
          })
          .then(data => {
            console.log('‚úÖ Google auth success:', data);
            
            if (data.success) {
              showStatus('Success! Redirecting...', 'success');
              
              // Small delay to show success message
              setTimeout(() => {
                window.location.replace(data.redirect || '/dashboard');
              }, 1000);
            } else {
              throw new Error(data.error || 'Unknown error');
            }
          })
          .catch(err => {
            console.error('‚ùå Google One Tap error:', err);
            showStatus('Authentication failed. Please try again.', 'warning');
            
            // Fallback: redirect to traditional Google OAuth
            setTimeout(() => {
              window.location.href = '/auth/google';
            }, 2000);
          });
        }

        // Initialize Google One Tap if needed
        window.onload = function() {
          if (window.google && window.google.accounts) {
            google.accounts.id.initialize({
              client_id: '<%= GOOGLE_CLIENT_ID || "" %>',
              callback: handleGoogleSignIn,
              context: 'signin',
              ux_mode: 'popup',
              auto_select: false
            });
            
            // Optional: prompt One Tap after a delay
            setTimeout(() => {
              google.accounts.id.prompt();
            }, 1000);
          }
        };
      </script>
</body>

</html>