<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Âä†Ê≤πÔºÅ - Connexion</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd"/>
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  
  <!-- Google One Tap -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-light d-flex align-items-center justify-content-center vh-100">
  <div class="container text-center">
    <div class="card shadow p-4" style="max-width: 400px; margin: auto;">
      <h1 class="mb-3">Âä†Ê≤πÔºÅ</h1>
      <p class="text-muted mb-4">Apprends et r√©vise ton vocabulaire chinois facilement.</p>

      <!-- Google One Tap CORRIG√â -->
      <div id="g_id_onload"
           data-client_id="<%= process.env.GOOGLE_CLIENT_ID %>"
           data-context="signin"
           data-ux_mode="popup"
           data-callback="handleGoogleSignIn"  <!-- ‚Üê AJOUT√â -->
           data-auto_prompt="true">  <!-- ‚Üê true pour meilleure UX -->
      </div>

      <div class="g_id_signin" 
           data-type="standard"
           data-size="large" 
           data-theme="outline" 
           data-text="signin_with" 
           data-shape="rectangular" 
           data-logo_alignment="left"
           data-width="350">
      </div>

      <!-- Fallback pour navigateurs sans One Tap -->
      <div id="fallback-auth" class="mt-3" style="display: none;">
        <a href="/auth/google" class="btn btn-outline-primary">
          Se connecter avec Google (m√©thode alternative)
        </a>
        <p class="text-muted small mt-2">
          Si le bouton ci-dessus ne fonctionne pas
        </p>
      </div>

      <div class="mt-3">
        <small class="text-muted">En te connectant, tu acceptes nos conditions d'utilisation</small>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/global.js"></script>
  <script>
    // Service Worker pour PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }

    // Fallback si Google One Tap ne charge pas
    setTimeout(() => {
      if (!window.google) {
        document.getElementById('fallback-auth').style.display = 'block';
      }
    }, 3000);

    // Gestion du callback Google One Tap CORRIG√âE
    function handleGoogleSignIn(response) {
      console.log('Google One Tap response received');
      
      // üî• CORRECTION : Utilise la route ONE-TAP, pas callback
      fetch('/auth/google/one-tap', {  // ‚Üê CHANG√â ICI
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ credential: response.credential })
      })
      .then(res => {
        if (!res.ok) throw new Error('HTTP error');
        return res.json();
      })
      .then(data => {
        if (data.success) {
          console.log('‚úÖ Login successful, redirecting...');
          window.location.href = data.redirect;
        } else {
          console.error('‚ùå Login failed:', data.error);
          alert('Erreur de connexion: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Login error:', err);
        alert('Erreur de connexion au serveur');
      });
    }

    // D√©tection PWA pour optimisation
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('üì± PWA mode detected');
    }
  </script>
</body>
</html>