<div class="d-flex justify-content-between align-items-center position-relative bg-primary text-white p-3"
     style="<%= currentPage === 'dashboard' ? 'background-color: transparent !important; color: inherit !important; padding: 0;' : '' %>">
  
  <% if (currentPage !== 'dashboard') { %>
    <!-- Logo/Titre (dispara√Æt sur dashboard) -->
    <span class="fs-3 fw-bold user-select-all" style="cursor: pointer;" onclick="window.location='/dashboard'">
      Âä†Ê≤πÔºÅ
    </span>
  <% } else { %>
    <!-- Spacer invisible pour garder l'espace du logo -->
    <div style="width: 3rem;"></div>
  <% } %>
  
  <div class="d-flex align-items-center gap-3">
    <!-- Solde compact, align√© horizontalement -->
    <a href="/bank" title="View account details" class="text-decoration-none">
      <div title="Your balance" class="d-flex align-items-center px-2 py-1 bg-white bg-opacity-10 rounded-pill text-white" 
           style="min-width: fit-content; gap: 8px; user-select: none; transition: all 0.2s ease; cursor: pointer;">
        <i class="fa-solid fa-coins fs-5"></i>
        <small class="text-white fw-semibold" style="font-size: 0.75rem;">balance :</small>
        <span id="game-balance" class="fw-bold fs-6"><%= Number(balance) + '‚Çµ' %></span>
      </div>
    </a>

    <!-- Mon Compte avec pastille de notifications pour les duels -->
    <div class="position-relative">
      <a href="/account" class="d-flex align-items-center text-white text-decoration-none fs-5 fw-semibold" 
         style="gap: 6px; transition: color 0.3s ease; position: relative;">
        <i class="bi bi-person-square"></i>
        <!-- Pastille de notifications pour les duels -->
        <span id="duel-notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary border border-white" 
              style="display: none; font-size: 0.6rem; padding: 0.25rem 0.4rem; min-width: 1.2rem;">
          <span id="duel-count">0</span>
        </span>
      </a>
    </div>
  </div>
</div>

<style>
/* Styles pour la pastille de notifications */
#duel-notification-badge {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s ease;
}

#duel-notification-badge:hover {
  transform: scale(1.1);
}

/* Style pour le hover du lien compte */
a[href="/account"]:hover {
  color: #cfe2ff !important;
}
</style>

<script>
// üî• MODIFICATION : V√©rifier si on est sur la page account
const isAccountPage = window.location.pathname === '/account';

window.addEventListener('load', function() {
  fetchAndUpdateBalance();
  if (!isAccountPage) {
    loadPendingDuels(); // Charger les duels en attente uniquement si PAS sur account
  }
});

// Stockage local pour suivre si la notification a d√©j√† √©t√© affich√©e aujourd'hui
function shouldShowDuelNotification() {
  const lastNotificationDate = localStorage.getItem('lastDuelNotificationDate');
  if (!lastNotificationDate) return true;
  
  const today = new Date().toDateString();
  const lastDate = new Date(lastNotificationDate).toDateString();
  
  return today !== lastDate;
}

function markDuelNotificationShown() {
  localStorage.setItem('lastDuelNotificationDate', new Date().toISOString());
}

// Fonction pour charger les duels en attente
async function loadPendingDuels() {
  // Ne pas ex√©cuter sur la page account
  if (isAccountPage) return;
  
  try {
    const response = await fetch('/api/duels/pending');
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const duels = await response.json();
    updateDuelNotification(duels.length);
    
    // Afficher une notification discr√®te UNE FOIS par jour maximum
    if (duels.length > 0 && shouldShowDuelNotification()) {
      console.log(`üéØ ${duels.length} pending duel(s)`);
      
      let message = '';
      if (duels.length === 1) {
        message = 'You have a pending duel';
      } else {
        message = `You have ${duels.length} pending duels`;
      }
      
      // Afficher une notification discr√®te
      showInfoNotification('Pending duel', message, {
        duration: 20000 // 4 secondes
      });
      
      // Marquer comme affich√© pour aujourd'hui
      markDuelNotificationShown();
    }
    
  } catch (error) {
    console.error('Error loading duels:', error);
    // En cas d'erreur, cacher la pastille
    const badge = document.getElementById('duel-notification-badge');
    if (badge) {
      badge.style.display = 'none';
    }
  }
}

// üî• MODIFICATION : Fonction simplifi√©e qui ne touche qu'aux √©l√©ments du header
function updateDuelNotification(count) {
  // Ne rien faire si on est sur la page account
  if (isAccountPage) return;
  
  const badge = document.getElementById('duel-notification-badge');
  const countElement = document.getElementById('duel-count');
  
  if (!badge || !countElement) return;
  
  if (count > 0) {
    countElement.textContent = count > 9 ? '9+' : count;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// üî• MODIFICATION : Gestionnaire de notifications uniquement pour les pages hors account
class NotificationManager {
  constructor() {
    // Ne pas initialiser sur la page account
    if (isAccountPage) return;
    
    this.notifications = [];
    this.maxNotifications = 1; // Une seule notification √† la fois
    this.init();
  }
  
  init() {
    document.addEventListener('showNotification', (e) => {
      this.show(e.detail);
    });
  }
  
  show(notification) {
    // Cr√©er un √©l√©ment de notification simple
    const notificationData = {
      id: Date.now() + Math.random(),
      type: notification.type || 'info',
      title: notification.title,
      message: notification.message,
      duration: notification.duration || 4000
    };
    
    // Supprimer toute notification existante
    this.hideAll();
    
    // Cr√©er et afficher la nouvelle notification
    this.createNotificationElement(notificationData);
    
    // Auto-hide si une dur√©e est sp√©cifi√©e
    if (notificationData.duration > 0) {
      setTimeout(() => {
        this.hide(notificationData.id);
      }, notificationData.duration);
    }
  }
  
  createNotificationElement(notification) {
    // Cr√©er l'√©l√©ment
    const notificationElement = document.createElement('div');
    notificationElement.className = `position-fixed top-0 end-0 mt-5 me-3 p-3 bg-white border border-${notification.type === 'success' ? 'success' : notification.type === 'error' ? 'danger' : notification.type === 'warning' ? 'warning' : 'primary'} rounded shadow-sm`;
    notificationElement.style.zIndex = '1060';
    notificationElement.style.maxWidth = '300px';
    notificationElement.style.animation = 'slideDown 0.3s ease-out';
    notificationElement.setAttribute('data-notification-id', notification.id);
    
    // Contenu en anglais
    notificationElement.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-bold mb-1">${notification.title}</div>
          <div class="text-muted small">${notification.message}</div>
        </div>
        <button type="button" class="btn-close btn-close-sm ms-2" 
                onclick="window.notificationManager.hide(${notification.id})"
                aria-label="Close"></button>
      </div>
    `;
    
    // Ajouter au body
    document.body.appendChild(notificationElement);
    
    // Stocker la r√©f√©rence
    this.notifications.push({
      id: notification.id,
      element: notificationElement
    });
  }
  
  hide(notificationId) {
    const notificationIndex = this.notifications.findIndex(n => n.id === notificationId);
    if (notificationIndex !== -1) {
      const notification = this.notifications[notificationIndex];
      notification.element.style.animation = 'slideUp 0.3s ease-out forwards';
      
      setTimeout(() => {
        if (notification.element.parentNode) {
          notification.element.parentNode.removeChild(notification.element);
        }
        this.notifications.splice(notificationIndex, 1);
      }, 300);
    }
  }
  
  hideAll() {
    this.notifications.forEach(notification => {
      this.hide(notification.id);
    });
    this.notifications = [];
  }
  
  // M√©thodes utilitaires pour les types courants
  success(title, message, options = {}) {
    this.show({ type: 'success', title, message, ...options });
  }
  
  error(title, message, options = {}) {
    this.show({ type: 'error', title, message, ...options });
  }
  
  warning(title, message, options = {}) {
    this.show({ type: 'warning', title, message, ...options });
  }
  
  info(title, message, options = {}) {
    this.show({ type: 'info', title, message, ...options });
  }
}

// üî• MODIFICATION : Ajouter les animations CSS uniquement si pas sur account
if (!isAccountPage) {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }
  `;
  document.head.appendChild(style);
}

// Fonctions pour r√©cup√©rer et mettre √† jour le solde
async function fetchAndUpdateBalance() {
  try {
    const res = await fetch('/api/balance', { credentials: 'include' });
    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`HTTP ${res.status}: ${errorText}`);
    }
    const data = await res.json();
    if (data.balance !== undefined) {
      updateGameBalance(data.balance);
    } else {
      throw new Error('Balance missing in response');
    }
  } catch (error) {
    console.error('Balance request error:', error);
  }
}

function updateGameBalance(newBalance) {
  const balanceEl = document.getElementById('game-balance');
  if (balanceEl) {
    balanceEl.textContent = newBalance + '‚Çµ';
  }
}

// üî• MODIFICATION : Initialisation uniquement si pas sur account
document.addEventListener('DOMContentLoaded', () => {
  if (!isAccountPage && !window.notificationManager) {
    window.notificationManager = new NotificationManager();
  }
});

// üî• MODIFICATION : Fonctions globales pour les notifications (uniquement si pas sur account)
function showNotification(notification) {
  if (isAccountPage) return; // Ne pas afficher de notifications sur account
  const event = new CustomEvent('showNotification', { detail: notification });
  document.dispatchEvent(event);
}

function showSuccessNotification(title, message, options) {
  if (isAccountPage) return;
  showNotification({ type: 'success', title, message, ...options });
}

function showErrorNotification(title, message, options) {
  if (isAccountPage) return;
  showNotification({ type: 'error', title, message, ...options });
}

function showWarningNotification(title, message, options) {
  if (isAccountPage) return;
  showNotification({ type: 'warning', title, message, ...options });
}

function showInfoNotification(title, message, options) {
  if (isAccountPage) return;
  showNotification({ type: 'info', title, message, ...options });
}
</script>

<script>
// Enregistrement SIMPLE et ROBUSTE du SW
if ('serviceWorker' in navigator && window.location.hostname === 'app.jiayou.fr') {
  
  // Petit d√©lai pour √©viter toute comp√©tition au chargement
  setTimeout(() => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('‚úÖ SW enregistr√© avec succ√®s.');
        
        // Optionnel : V√©rifie s'il y a une mise √† jour en attente
        if (registration.waiting) {
          console.log('üîÑ Un nouveau SW est en attente.');
          // Ici, vous pourriez afficher un bouton "Mettre √† jour" discret
        }
        
        // √âcoute les messages du SW (comme SW_READY)
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data.type === 'SW_READY') {
            console.log(`üü¢ SW ${event.data.version} est pr√™t.`);
          }
        });
        
      })
      .catch(err => {
        console.error('‚ùå √âchec de l‚Äòenregistrement SW:', err);
        // En cas d'erreur grave, on nettoie pour repartir √† z√©ro
        navigator.serviceWorker.getRegistrations()
          .then(regs => Promise.all(regs.map(r => r.unregister())))
          .then(() => console.log('üßπ Anciens SW d√©sinscrits.'));
      });
  }, 500); // D√©lai r√©duit √† 500ms
}
</script>