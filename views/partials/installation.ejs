<!-- Bouton d'installation PWA -->
<div id="pwa-install-container" class="position-fixed bottom-0 end-0 m-3" style="display: none; z-index: 9999;">
  <button id="pwa-install-btn" class="btn btn-success shadow-lg d-flex align-items-center">
    <i class="bi bi-download me-2"></i> 
    <span>Installer l'app</span>
  </button>
</div>

<script>
// Gestion de l'installation PWA
function initPWAInstall() {
  let deferredPrompt;
  const installContainer = document.getElementById('pwa-install-container');
  const installButton = document.getElementById('pwa-install-btn');
  
  if (!installContainer || !installButton) {
    console.log('‚ùå PWA install elements not found');
    return;
  }
  
  // √âv√©nement quand l'app peut √™tre install√©e
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üéØ PWA installable detected');
    e.preventDefault();
    deferredPrompt = e;
    
    // Afficher le bouton avec animation
    installContainer.style.display = 'block';
    installContainer.style.animation = 'slideInUp 0.3s ease-out';
    
    // Auto-cacher apr√®s 30 secondes
    setTimeout(() => {
      if (installContainer.style.display !== 'none') {
        installContainer.style.animation = 'slideOutDown 0.3s ease-out';
        setTimeout(() => {
          installContainer.style.display = 'none';
        }, 300);
      }
    }, 30000);
  });
  
  // Cacher le bouton si l'app est d√©j√† install√©e
  window.addEventListener('appinstalled', () => {
    console.log('‚úÖ PWA installed');
    installContainer.style.animation = 'slideOutDown 0.3s ease-out';
    setTimeout(() => {
      installContainer.style.display = 'none';
    }, 300);
    deferredPrompt = null;
  });
  
  // Gestion du clic sur le bouton
  installButton.addEventListener('click', async () => {
    if (!deferredPrompt) {
      console.log('‚ùå No install prompt available');
      return;
    }
    
    try {
      // D√©clencher l'installation
      deferredPrompt.prompt();
      
      // Attendre le choix de l'utilisateur
      const { outcome } = await deferredPrompt.userChoice;
      
      console.log(`User response: ${outcome}`);
      
      if (outcome === 'accepted') {
        installContainer.style.animation = 'slideOutDown 0.3s ease-out';
        setTimeout(() => {
          installContainer.style.display = 'none';
        }, 300);
        
        // Tracking optionnel
        if (typeof gtag !== 'undefined') {
          gtag('event', 'install', {
            'event_category': 'PWA',
            'event_label': 'manual_install'
          });
        }
      }
      
      deferredPrompt = null;
    } catch (error) {
      console.error('Installation error:', error);
    }
  });
  
  // V√©rifier si l'app est d√©j√† install√©e
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('üì± App already installed');
    installContainer.style.display = 'none';
  }
  
  // V√©rifier sur iOS (m√©thode diff√©rente)
  if (window.navigator.standalone === true) {
    console.log('üì± iOS PWA detected');
    installContainer.style.display = 'none';
  }
}

// Initialiser quand la page est charg√©e
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPWAInstall);
} else {
  // DOM d√©j√† charg√©
  initPWAInstall();
}

// R√©initialiser si navigation SPA
if (typeof window.SPA !== 'undefined') {
  window.addEventListener('pageChanged', initPWAInstall);
}
</script>

<style>
#pwa-install-container {
  animation-duration: 0.3s;
  animation-timing-function: ease-out;
}

@keyframes slideInUp {
  from { 
    transform: translateY(100px); 
    opacity: 0; 
  }
  to { 
    transform: translateY(0); 
    opacity: 1; 
  }
}

@keyframes slideOutDown {
  from { 
    transform: translateY(0); 
    opacity: 1; 
  }
  to { 
    transform: translateY(100px); 
    opacity: 0; 
  }
}

/* Responsive design */
@media (max-width: 576px) {
  #pwa-install-container {
    bottom: 80px; /* Au-dessus de la navbar mobile */
    end: 15px;
    margin: 0 !important;
  }
  
  #pwa-install-btn {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
  }
}

/* Mode sombre */
@media (prefers-color-scheme: dark) {
  #pwa-install-btn {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%);
    border: none;
  }
}

/* Hover effects */
#pwa-install-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(25, 135, 84, 0.3) !important;
  transition: all 0.2s ease;
}

#pwa-install-btn:active {
  transform: translateY(0);
}
</style>