<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ æ²¹! Quiz CaractÃ¨res</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd"/>
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</head>
<body>

<%- include('partials/header') %>
s<%- include('partials/navbar', {currentPage: 'quiz-character'}) %>

  <div class="quiz-container container my-4 p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-6">

    <!-- Question -->
    <div id="quizQuestion" class="mb-3 fw-bold fs-5 text-center"></div>

    <!-- RÃ©sultat AU DESSUS des champs -->
    <div id="quizResult" class="badge bg-light text-dark border mb-3 p-2 fs-6"></div>

    <!-- Formulaire du quiz -->
    <form id="quizForm" class="p-4 bg-light rounded gap-4 d-flex flex-column">
      <div id="quizFields" class="d-flex flex-wrap justify-content-center gap-2"></div>

      <!-- Boutons - seulement "Soumettre" -->
      <div class="d-flex flex-column gap-2">
        <button type="submit" id="checkBtn" class="btn btn-primary w-100">Soumettre</button>

      </div>
    </form>
    
    <!-- Score -->
    <div id="quizScore" class="mb-3 fw-bold text-center">âœ… 0 | âŒ 0</div>
    
  </div>

  <script src="/js/global.js"></script>
  <script src="/js/saveQuiz.js"></script>
  <script>
let quizWords = []; 
let quizResults = [];
let quizIdx = 0;
let quizInputs = [];
let correctCount = 0;
let wrongCount = 0;
let currentWord = null;
let hasSecondChance = false;

const quizQuestion = document.getElementById('quizQuestion');
const quizFields = document.getElementById('quizFields');
const checkBtn = document.getElementById('checkBtn');
const quizResult = document.getElementById('quizResult');
const quizForm = document.getElementById('quizForm');
const quizScore = document.getElementById('quizScore');

const urlParams = new URLSearchParams(window.location.search);
let quizCount = urlParams.get('count');
let hskLevel = urlParams.get('hsk') || 'all'; // â¬…ï¸ NOUVEAU : RÃ©cupÃ¨re le filtre HSK

if (quizCount !== "all") {
  quizCount = parseInt(quizCount);
}

// ğŸ”¥ FONCTIONS UTILITAIRES
function shuffleArray(arr) {
    for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

function disableSubmitButton() {
    const submitBtn = document.getElementById('checkBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Chargement...';
    submitBtn.classList.add('disabled');
}

function enableSubmitButton() {
    const submitBtn = document.getElementById('checkBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Soumettre';
    submitBtn.classList.remove('disabled');
}

function updateScore() {
    quizScore.textContent = `âœ… ${correctCount} | âŒ ${wrongCount}`;
}

async function saveQuizResults(score, totalQuestions, quizType, results) {
    try {
        const response = await fetch('/api/quiz/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                score: score,
                total_questions: totalQuestions,
                quiz_type: quizType,
                results: results
            })
        });
        
        const data = await response.json();
        console.log('ğŸ“¥ RÃ©ponse sauvegarde:', data);
        
    } catch (error) {
        console.error('âŒ Erreur sauvegarde quiz:', error);
    }
}

// ğŸ”¥ INIT TRACKING
function initQuizTracking() {
    quizResults = quizWords.map(word => {
        return {
            mot_id: word.id,
            chinese: word.chinese,
            pinyin: word.pinyin,
            english: word.english,
            correct: null,
            attempts: 0
        };
    });
}

// ğŸ”¥ CHARGEMENT QUIZ AVEC FILTRE HSK
async function loadQuizWords(count = 10, hsk = 'all') { // â¬…ï¸ MODIFIÃ‰ : ajout paramÃ¨tre hsk
    const res = await fetch(`/quiz-mots?count=${encodeURIComponent(count)}&hsk=${encodeURIComponent(hsk)}`);
    const mots = await res.json();

    if (!mots.length) {
        quizQuestion.textContent = 'âš ï¸ Aucun mot disponible pour ce niveau HSK. Ajoutez des mots pour lancer le quiz.';
        checkBtn.style.display = 'none';
        return;
    }

    shuffleArray(mots);
    quizWords = (count === 'all' || count >= mots.length) ? mots : mots.slice(0, count);
    
    initQuizTracking();
    
    quizIdx = 0;
    correctCount = 0;
    wrongCount = 0;
    hasSecondChance = false;
    updateScore();
    checkBtn.style.display = 'inline-block';
    showQuizWord();
}

// ğŸ”¥ AFFICHAGE - UN SEUL CHAMP GLOBAL
function showQuizWord() {
    quizFields.innerHTML = '';
    quizInputs = [];
    quizResult.textContent = '';
    hasSecondChance = false;

    if (quizIdx >= quizWords.length) {
        endQuiz();
        return;
    }

    enableSubmitButton();
    currentWord = quizWords[quizIdx];

    // ğŸ”¥ QUESTION CARACTÃˆRES
    quizQuestion.textContent = `Comment Ã©crire "${currentWord.english}" en chinois ?`;

    // ğŸ”¥ UN SEUL CHAMP GLOBAL
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.placeholder = 'Ã‰crivez les caractÃ¨res chinois ici...';
    inp.className = 'form-control form-control-lg text-center';
    inp.style.fontSize = '20px';
    inp.style.padding = '15px';
    inp.autocomplete = 'off';
    
    quizFields.appendChild(inp);
    quizInputs.push(inp);

    // Focus et sÃ©lection du texte
    inp.focus();
    inp.select();
}

// ğŸ”¥ SOUMISSION - UN SEUL CHAMP
quizForm.onsubmit = (e) => {
    e.preventDefault();
    disableSubmitButton();

    // ğŸ”¥ UN SEUL CHAMP - valeur directe
    const userAnswer = quizInputs[0].value.trim();
    const correctAnswer = currentWord.chinese;
    const isCorrect = userAnswer === correctAnswer;

    // Tracking des rÃ©sultats
    const currentResultIndex = quizResults.findIndex(result => result.mot_id === currentWord.id);
    if (currentResultIndex !== -1) {
        if (!hasSecondChance) {
            quizResults[currentResultIndex].correct = isCorrect;
            quizResults[currentResultIndex].attempts = 1;
        } else {
            quizResults[currentResultIndex].correct = false;
            quizResults[currentResultIndex].attempts = 2;
        }
    }

    if (isCorrect) {
        quizResult.textContent = "âœ… Correct !";
        quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
        
        if (!hasSecondChance) correctCount++;
        
        updateScore();
        quizIdx++;
        
        setTimeout(() => {
            enableSubmitButton();
            showQuizWord();
        }, 1500);
        
    } else {
        if (!hasSecondChance) {
            wrongCount++;
            updateScore();
            
            quizResult.textContent = `âŒ Wrong ! Correct anwer is : ${correctAnswer}`;
            quizResult.className = "alert alert-info mb-3 text-center border-0 py-2";
            hasSecondChance = true;
            
            // Vide et prÃ©pare pour la seconde chance
            quizInputs[0].value = '';
            quizInputs[0].style.border = '2px solid #dc3545';
            quizInputs[0].focus();
            
            enableSubmitButton();
            
        } else {
            quizResult.textContent = `âœ… Bien ! RÃ©ponse : ${correctAnswer}`;
            quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
            
            quizIdx++;
            
            setTimeout(() => {
                enableSubmitButton();
                showQuizWord();
            }, 1500);
        }
    }
};

// ğŸ”¥ FIN QUIZ
function endQuiz() {
    quizQuestion.textContent = 'ğŸ‰ Quiz terminÃ© !';
    quizResult.textContent = `Score final: ${correctCount}/${quizWords.length}`;
    quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
    checkBtn.style.display = 'none';
    quizFields.innerHTML = '';
    
    // Sauvegarde avec type "character"
    saveQuizResults(correctCount, quizWords.length, 'character', quizResults);
    
    setTimeout(() => { 
        window.location.href = '/dashboard'; 
    }, 3000);
}

// Lancer le quiz avec les paramÃ¨tres HSK
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ¯ ParamÃ¨tres quiz character:', { 
        count: quizCount || 10, 
        hsk: hskLevel 
    });
    loadQuizWords(quizCount || 10, hskLevel); // â¬…ï¸ MODIFIÃ‰ : passe le hskLevel
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>