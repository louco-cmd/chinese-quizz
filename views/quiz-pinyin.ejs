<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Âä†Ê≤π! Quiz Pinyin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0d6efd"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
</script>
</head>
<body>
<%- include('partials/header') %>
<%- include('partials/navbar', {currentPage: 'quiz-pinyin'}) %>

<div class="quiz-container container my-4 p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-6">

  <!-- Question -->
  <div id="quizQuestion" class="mb-3 fw-bold fs-5 text-center"></div>

  <!-- R√©sultat AU DESSUS des champs -->
  <div id="quizResult" class="badge bg-light text-dark border mb-3 p-2 fs-6"></div>
  <div id="chineseCharacter" class="mb-3 text-center" style="display: none;">
  <div class="chinese-char fs-1 fw-bold text-dark mb-2"></div>
  <div class="pinyin-display fs-5 text-muted"></div>
</div>

  <!-- Formulaire du quiz -->
  <form id="quizForm" class="p-4 bg-light rounded gap-4 d-flex flex-column">
    <div id="quizFields" class="d-flex flex-row gap-2 justify-content-center"></div>

    <!-- Boutons - seulement "Soumettre" -->
    <div class="d-flex flex-column gap-2">
      <button type="submit" id="checkBtn" class="btn btn-primary w-100">Soumettre</button>
    </div>
  </form>

  <!-- Score -->
  <div id="quizScore" class="mb-3 fw-bold text-center">‚úÖ 0 | ‚ùå 0</div>
  
</div>

<script src="/js/global.js"></script>
<script src="/js/saveQuiz.js"></script>
<script src="/js/tts-chinese.js"></script>
<script src="/js/card-function.js"></script>
<script>
let quizWords = []; 
let quizResults = [];
let quizIdx = 0;
let quizInputs = [];
let correctCount = 0;
let wrongCount = 0;
let currentWord = null;
let hasSecondChance = false;

const quizQuestion = document.getElementById('quizQuestion');
const quizFields = document.getElementById('quizFields');
const checkBtn = document.getElementById('checkBtn');
const quizResult = document.getElementById('quizResult');
const quizForm = document.getElementById('quizForm');
const quizScore = document.getElementById('quizScore');
const chineseCharacter = document.getElementById('chineseCharacter');
const chineseChar = chineseCharacter.querySelector('.chinese-char');
const pinyinDisplay = chineseCharacter.querySelector('.pinyin-display');

const urlParams = new URLSearchParams(window.location.search);
let quizCount = urlParams.get('count');

if (quizCount !== "all") {
  quizCount = parseInt(quizCount);
}

function shuffleArray(arr) {
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// MODIFIER loadQuizWords :
async function loadQuizWords(count, hskLevel = 'all') {
  try {
    // Ajouter le count ET le filtre HSK dans l'URL
    const res = await fetch(`/quiz-mots?count=${encodeURIComponent(count)}&hsk=${encodeURIComponent(hskLevel)}`);
    const mots = await res.json();

    if (!mots.length) {
      quizQuestion.textContent = '‚ö†Ô∏è Aucun mot disponible pour ce niveau HSK.';
      checkBtn.style.display = 'none';
      return;
    }

    // Utiliser directement les mots retourn√©s par le serveur
    quizWords = mots;
    
    initQuizTracking();
    quizIdx = 0;
    correctCount = 0;
    wrongCount = 0;
    hasSecondChance = false;
    updateScore();
    checkBtn.style.display = 'inline-block';
    showQuizWord();
    
    console.log(`üìö ${quizWords.length} mots charg√©s (HSK: ${hskLevel})`);
  } catch (error) {
    console.error('Erreur lors du chargement des mots:', error);
    quizQuestion.textContent = '‚ö†Ô∏è Erreur lors du chargement des mots.';
  }
}
function initQuizTracking() {
    quizResults = quizWords.map(word => {
        return {
            mot_id: word.id, // üî• C'EST √áA qu'il faut utiliser !
            chinese: word.chinese,
            pinyin: word.pinyin,
            english: word.english,
            correct: null, // sera true/false apr√®s r√©ponse
            attempts: 0
        };
    });
}

function showQuizWord() {
  // üî• SUPPRIME LE DOUBLON - garde seulement une fois ces lignes :
  quizFields.innerHTML = '';
  quizInputs = []
  quizResult.textContent = '';
  hasSecondChance = false;

  if (quizIdx >= quizWords.length) {
    endQuiz();
    return;
  }
  
  enableSubmitButton(); // üî• R√âACTIVER LE BOUTON POUR LA NOUVELLE QUESTION
  
  currentWord = quizWords[quizIdx];
  quizQuestion.textContent = `How to say "${currentWord.english}" in pinyin ?`;

  const answer = currentWord.pinyin; 
  const answerParts = answer.split(' ');

  answerParts.forEach((part, i) => {
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.maxLength = part.length;
    inp.placeholder = part.length + ' caract√®res';
    inp.className = 'form-control text-center flex-fill';
    inp.addEventListener('input', (e) => {
      if (e.target.value.length >= e.target.maxLength && quizInputs[i+1]){
        quizInputs[i+1].focus();
      }
    });
    quizFields.appendChild(inp);
    quizInputs.push(inp);
  });

  quizInputs[0].focus();
}

function normalizePinyin(str) {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "")
    .toLowerCase()
    .trim();
}

function updateScore() {
  quizScore.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;
}


// üî• FONCTIONS POUR G√âRER LE BOUTON
function disableSubmitButton() {
  const submitBtn = document.getElementById('checkBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Chargement...';
  submitBtn.classList.add('disabled');
}

function enableSubmitButton() {
  const submitBtn = document.getElementById('checkBtn');
  submitBtn.disabled = false;
  submitBtn.innerHTML = 'Soumettre';
  submitBtn.classList.remove('disabled');
}

// üî• PUIS DANS quizForm.onsubmit, remplace par :
quizForm.onsubmit = (e) => {
  e.preventDefault();
  disableSubmitButton();

  const userAnswer = normalizePinyin(quizInputs.map(inp => inp.value).join(""));
  const correctAnswer = normalizePinyin(currentWord.pinyin);
  const isCorrect = userAnswer === correctAnswer;

    const currentResultIndex = quizResults.findIndex(result => 
    result.pinyin === currentWord.pinyin && result.english === currentWord.english
  );

  if (currentResultIndex !== -1) {
    console.log(`üéØ Mise √† jour index ${currentResultIndex}:`, currentWord);
    quizResults[currentResultIndex].correct = isCorrect;
    quizResults[currentResultIndex].attempts = hasSecondChance ? 2 : 1;
  } else {
    console.error('‚ùå Impossible de trouver le mot dans quizResults:', currentWord);
  }

  console.log('üéØ Avant mise √† jour quizResults:', quizResults[quizIdx]);

  // NOUVEAU: Sauvegarder le r√©sultat pour ce mot sp√©cifique
  quizResults[quizIdx].correct = isCorrect;
  quizResults[quizIdx].attempts = hasSecondChance ? 2 : 1;

  console.log('üéØ Apr√®s mise √† jour quizResults:', quizResults[quizIdx]);
  
  if (isCorrect) {
    quizResult.textContent = "‚úÖ Correct !";
    quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
    
    if (!hasSecondChance) {
      correctCount++;
    }
    
    updateScore();
    quizIdx++;
    
    setTimeout(() => {
      enableSubmitButton();
      showQuizWord();
    }, 1500);
    
  } else {
    if (!hasSecondChance) {
      wrongCount++;
      updateScore();
      
      quizResult.textContent = `‚ùå Wrong ! Correct anwer is : ${currentWord.pinyin}`;

      showCharacterCard(currentWord);
            
      quizResult.className = "alert alert-info mb-3 text-center border-0 py-2";
      hasSecondChance = true;
      
      quizInputs.forEach(input => {
        input.value = '';
        input.style.border = '1px solid #dc3545';
        input.style.boxShadow = '0 0 0 0rem rgba(220, 53, 69, 0.25)';
      });
      quizInputs[0].focus();
      
      enableSubmitButton();
      
    } else {
      quizResult.textContent = `‚úÖ Bien ! Correct : ${currentWord.pinyin}`;
      quizResult.className = "mb-3 text-center text-success fw-bold fs-4";
      
      quizIdx++;
      
      setTimeout(() => {
        enableSubmitButton();
        showQuizWord();
        hideCharacterCard()
      }, 1500);
    }
  }
};

function showCharacterCard(word) {
    // Cr√©er la carte
    const card = document.createElement('div');
    card.className = 'card card-custom-bg rounded-4 shadow-sm p-3 mb-0 mx-auto';
    card.style.cssText = 'width: 280px; max-width: 100%; background: #FFF4F2; border: 1px solid #FDA297;';
    
    const hskLevelDisplay = word.hsk || 'Street';
    const chineseFontSizeClass = (word.chinese && word.chinese.length >= 3) ? 'fs-2' : 'fs-1';
    
    card.innerHTML = `
        <div class="card-body text-center p-0">
            <!-- En-t√™te avec HSK -->
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="hsk-tag-custom py-1 border border-light small">
                    HSK : ${hskLevelDisplay}
                </span>
                <button class="btn btn-sm btn-audio" 
                        data-text="${word.chinese}"
                        title="√âcouter la prononciation">
                    <i class="bi bi-volume-up"></i>
                </button>
            </div>
            
            <!-- Caract√®re chinois avec hover -->
            <div class="bg-white border rounded-3">
                <div class="${chineseFontSizeClass} text-dark chinese-clickable" 
                     data-word-id="${word.id}"
                     data-chinese-text="${word.chinese}"
                     style="cursor: help; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                    ${word.chinese}
                </div>
            </div>
          
        </div>
    `;

    // Ajouter la carte au-dessus du formulaire
    card.id = 'character-card-feedback';
    quizForm.parentNode.insertBefore(card, quizForm);
    
    // Activer les fonctionnalit√©s interactives
    activateCardFeatures(card, word);
}

function hideCharacterCard() {
    const card = document.getElementById('character-card-feedback');
    if (card) {
        card.remove();
    }
}

// Lancer le quiz
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const count = urlParams.get('count') || '20';
  const hskLevel = urlParams.get('hsk') || 'all';
  
  console.log('üéØ Param√®tres quiz:', { count, hskLevel });
  
  // Passer le hskLevel √† loadQuizWords
  loadQuizWords(count, hskLevel);
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>