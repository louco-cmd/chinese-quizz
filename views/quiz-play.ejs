<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Âä†Ê≤π! Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <style>
    .syllable-input {
      min-width: 100px;
      text-align: center;
    }

    .character-input {
      font-size: 24px !important;
      height: 60px !important;
      text-align: center !important;
    }

    .chinese-character {
      cursor: help;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .chinese-character:hover {
      background-color: rgba(13, 110, 253, 0.1);
    }

    .character-modal {
      position: fixed;
      width: 200px;
      height: auto;
      z-index: 10000;
      display: none;
      background: white;
      border: 2px solid #0d6efd;
      border-radius: 10px;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      padding: 15px;
      pointer-events: auto;
    }
  </style>
</head>

<body>
  <%- include('partials/header') %>
  <%- include('partials/navbar', {currentPage: 'quiz-play' }) %>

  <div class="quiz-container container p-4 bg-light rounded shadow-sm col-12 col-md-10 col-lg-8 mx-auto mt-4">

    <!-- Question -->
    <div id="quizQuestion" class="mb-4 fw-bold fs-3 text-center"></div>

    <!-- Result -->
    <div id="quizResult" class="alert mb-4 text-center" style="display: none;"></div>

    <!-- Quiz form -->
    <form id="quizForm" class="p-4 bg-white rounded gap-4 d-flex flex-column">
      <div id="quizFields" class="d-flex flex-wrap justify-content-center gap-2 mb-3"></div>

      <!-- Buttons -->
      <div class="d-flex flex-column gap-2">
        <button type="submit" id="checkBtn" class="btn btn-primary w-100 btn-lg">
          <i class="bi bi-send-check me-2"></i>Submit
        </button>
      </div>
    </form>

    <!-- Score and Progress -->
    <div class="row mt-4">
      <div class="col-12 col-md-6">
        <div id="quizScore" class="fw-bold text-center fs-5">‚úÖ 0 | ‚ùå 0</div>
      </div>
      <div class="col-12 col-md-6">
        <div id="quizProgress" class="text-muted fw-medium text-center">Question 1/10</div>
      </div>
    </div>

  </div>

  <script src="/js/global.js"></script>
  <script src="/js/saveQuiz.js"></script>
  <script src="/js/tts-chinese.js"></script>
  <script src="/js/card-function.js"></script>
  <script>
    // ==================================================
    // GLOBAL VARIABLES
    // ==================================================

    let quizWords = [];
    let quizResults = [];
    let quizIdx = 0;
    let quizInputs = [];
    let correctCount = 0;
    let wrongCount = 0;
    let currentWord = null;
    let hasSecondChance = false;
    let quizEnded = false;
    let quizType = null;
    let hskLevel = 'all';
    let quizCount = 10;

    // üî• CORRECTION : V√©rifier si les variables existent d√©j√†
    if (typeof window.hoverModal === 'undefined') window.hoverModal = null;
    if (typeof window.cacheMots === 'undefined') window.cacheMots = null;
    if (typeof window.dernierFetch === 'undefined') window.dernierFetch = 0;
    if (typeof window.CACHE_DURATION === 'undefined') window.CACHE_DURATION = 5 * 60 * 1000;
    if (typeof window.hoverTimeout === 'undefined') window.hoverTimeout = null;

    // DOM elements
    const quizQuestion = document.getElementById('quizQuestion');
    const quizFields = document.getElementById('quizFields');
    const checkBtn = document.getElementById('checkBtn');
    const quizResult = document.getElementById('quizResult');
    const quizForm = document.getElementById('quizForm');
    const quizScore = document.getElementById('quizScore');
    const quizProgress = document.getElementById('quizProgress');


    // Initialize on load
    document.addEventListener('DOMContentLoaded', async function() {
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      quizType = urlParams.get('type') || 'pinyin';
      quizCount = urlParams.get('count') || '10';
      hskLevel = urlParams.get('hsk') || 'all';

      // Load and start quiz
      await loadQuizWords();
    });

    // Load words for quiz - VERSION AM√âLIOR√âE
    // Load words for quiz - VERSION CORRIG√âE
    async function loadQuizWords() {
      try {
        // Show loading message
        quizQuestion.textContent = 'Loading words...';
        disableSubmitButton();

        // Call API with parameters
        const res = await fetch(`/quiz-mots?count=${encodeURIComponent(quizCount)}&hsk=${encodeURIComponent(hskLevel)}&type=${encodeURIComponent(quizType)}`);

        // üî• V√âRIFIER SP√âCIFIQUEMENT LA LIMITE (403)
        if (res.status === 403) {
          const errorData = await res.json();

          // Afficher la popup de limite
          if (errorData.limitReached && errorData.type === 'quiz') {
            showQuizLimitPopup(errorData);

            // Afficher un message dans le quiz aussi
            quizQuestion.textContent = '‚õî Daily Quiz Limit Reached';
            quizResult.innerHTML = `
          <div class="alert alert-warning">
            <strong>You've reached your daily limit!</strong><br>
            You've taken ${errorData.current || 0}/${errorData.max || 5} quizzes today.<br>
            <a href="/pricing" class="btn btn-sm btn-primary mt-2">
              <i class="bi bi-star-fill me-1"></i>Upgrade to Premium
            </a>
            <button onclick="window.location.href='/quiz'" class="btn btn-sm btn-outline-secondary mt-2 ms-2">
              <i class="bi bi-arrow-left me-1"></i>Back to Quiz Menu
            </button>
          </div>
        `;
            quizResult.style.display = 'block';
            return;
          }
        }

        if (!res.ok) {
          throw new Error(`HTTP error ${res.status}`);
        }

        // üî• CORRECTION : Votre API renvoie {success: true, words: [...]}
        const responseData = await res.json();

        // DEBUG: Afficher ce que re√ßoit le frontend
        console.log('üì• API Response:', responseData);

        // Extraire les mots de la r√©ponse
        let mots;
        if (responseData.words && Array.isArray(responseData.words)) {
          // Format actuel de votre API
          mots = responseData.words;
          console.log(`‚úÖ ${mots.length} mots extraits de responseData.words`);
        } else if (Array.isArray(responseData)) {
          // Format ancien (tableau direct)
          mots = responseData;
          console.log(`‚úÖ ${mots.length} mots re√ßus (format tableau)`);
        } else {
          // Format inattendu
          console.warn('‚ùå Format de r√©ponse inattendu:', responseData);
          mots = [];
        }

        // üî• AJOUTER UN LOG D√âTAILL√â
        console.log('üîç D√©tails des mots re√ßus:');
        console.log('- Nombre:', mots.length);
        if (mots.length > 0) {
          console.log('- Premier mot:', {
            id: mots[0].id,
            chinese: mots[0].chinese,
            pinyin: mots[0].pinyin,
            english: mots[0].english,
            score: mots[0].score
          });
        }

        if (!mots || !mots.length) {
          quizQuestion.textContent = '‚ö†Ô∏è No words available for these parameters.';
          quizResult.innerHTML = `
        <div class="alert alert-warning">
          <strong>No words available</strong><br>
          <p>API returned ${mots ? 0 : 'no data'}. Server response:</p>
          <pre class="small">${JSON.stringify(responseData, null, 2)}</pre>
          <button onclick="window.location.href='/quiz'" class="btn btn-sm btn-outline-secondary mt-2">
            <i class="bi bi-arrow-left me-1"></i>Back to Quiz Menu
          </button>
          <button onclick="window.location.reload()" class="btn btn-sm btn-outline-primary mt-2 ms-2">
            <i class="bi bi-arrow-clockwise me-1"></i>Retry
          </button>
        </div>
      `;
          quizResult.style.display = 'block';
          return;
        }

        quizWords = mots;
        initQuizTracking();
        quizIdx = 0;
        correctCount = 0;
        wrongCount = 0;
        hasSecondChance = false;
        quizEnded = false;

        updateScore();
        updateProgress();
        enableSubmitButton();

        showQuizWord();

      } catch (error) {
        console.error('Error loading words:', error);

        // Gestion des erreurs r√©seau
        if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
          quizQuestion.textContent = 'üåê Network Error';
          quizResult.innerHTML = `
        <div class="alert alert-danger">
          <strong>Connection problem</strong><br>
          Please check your internet connection and try again.<br>
          <button onclick="window.location.reload()" class="btn btn-sm btn-outline-danger mt-2">
            <i class="bi bi-arrow-clockwise me-1"></i>Reload Page
          </button>
        </div>
      `;
        } else {
          quizQuestion.textContent = '‚ö†Ô∏è Error loading words.';
          quizResult.innerHTML = `
        <div class="alert alert-danger">
          <strong>Error</strong><br>
          ${error.message}<br>
          <button onclick="window.location.href='/quiz'" class="btn btn-sm btn-outline-danger mt-2">
            <i class="bi bi-arrow-left me-1"></i>Back to Quiz Menu
          </button>
        </div>
      `;
        }

        quizResult.style.display = 'block';
      }
    }
    
    // Initialize results tracking
    function initQuizTracking() {
      quizResults = quizWords.map(word => {
        return {
          mot_id: word.id,
          chinese: word.chinese,
          pinyin: word.pinyin,
          english: word.english,
          quiz_mode: quizType,
          correct: null,
          attempts: 0
        };
      });
    }

    // Show a question
    function showQuizWord() {
      if (quizEnded || quizIdx >= quizWords.length) {
        endQuiz();
        return;
      }

      // Reset interface
      quizFields.innerHTML = '';
      quizInputs = [];
      quizResult.style.display = 'none';
      hasSecondChance = false;
      // üî• CORRECTION : Toujours cacher la carte quand on passe √† une nouvelle question
      hideCharacterCard();
      enableSubmitButton();

      // Get current word
      currentWord = quizWords[quizIdx];
      updateProgress();

      // Show according to quiz type
      if (quizType === 'pinyin') {
        showPinyinQuestion();
      } else {
        showCharacterQuestion();
      }

      // Focus on first field
      if (quizInputs.length > 0) {
        quizInputs[0].focus();
      }
    }

    // Show a pinyin question
    function showPinyinQuestion() {
      quizQuestion.textContent = `How to say "${currentWord.english}" in pinyin?`;

      // Create fields for each syllable
      const syllables = currentWord.pinyin.split(' ');

      syllables.forEach((syllable, index) => {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'd-flex flex-column align-items-center';

        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'form-control syllable-input mb-1';
        // üî• CORRECTION : "x letters" au lieu de "x characters"
        inp.placeholder = `${syllable.length} letters`;
        inp.maxLength = syllable.length;

        // Auto-focus management
        inp.addEventListener('input', (e) => {
          if (e.target.value.length >= e.target.maxLength && quizInputs[index + 1]) {
            quizInputs[index + 1].focus();
          }
        });

        // üî• SUPPRESSION : Plus d'indicateur de syllabe
        inputGroup.appendChild(inp);
        quizFields.appendChild(inputGroup);
        quizInputs.push(inp);
      });
    }

    // Show a character question
    function showCharacterQuestion() {
      quizQuestion.textContent = `How to write "${currentWord.english}" in Chinese characters?`;

      // Single field for characters
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'form-control character-input';
      inp.placeholder = 'Write Chinese characters here...';
      inp.autocomplete = 'off';
      inp.spellcheck = false;

      quizFields.appendChild(inp);
      quizInputs.push(inp);
    }

    // Update progress
    function updateProgress() {
      quizProgress.textContent = `Question ${quizIdx + 1}/${quizWords.length}`;
    }

    // Update score
    function updateScore() {
      quizScore.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;
    }

    // Normalize pinyin for comparison
    function normalizePinyin(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "")
        .toLowerCase()
        .trim();
    }

    // Disable submit button
    function disableSubmitButton() {
      checkBtn.disabled = true;
      checkBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Loading...';
      checkBtn.classList.add('disabled');
    }

    // Enable submit button
    function enableSubmitButton() {
      checkBtn.disabled = false;
      checkBtn.innerHTML = '<i class="bi bi-send-check me-2"></i>Submit';
      checkBtn.classList.remove('disabled');
    }

    // Form submission handling
    quizForm.onsubmit = (e) => {
      e.preventDefault();
      disableSubmitButton();

      const isCorrect = checkAnswer();

      // Record result - CORRECTION
      if (quizResults[quizIdx]) {
        // üî• CORRECTION : Ne mettre √† jour 'correct' que sur PREMI√àRE tentative
        if (!hasSecondChance) {
          quizResults[quizIdx].correct = isCorrect; // ‚Üê SEULEMENT quand pas de 2√®me chance
        }
        quizResults[quizIdx].attempts = hasSecondChance ? 2 : 1;
      }

      if (isCorrect) {
        handleCorrectAnswer();
      } else {
        handleIncorrectAnswer();
      }
    };

    // Check answer
    function checkAnswer() {
      if (quizType === 'pinyin') {
        const userAnswer = normalizePinyin(quizInputs.map(inp => inp.value).join(" "));
        const correctAnswer = normalizePinyin(currentWord.pinyin);
        return userAnswer === correctAnswer;
      } else {
        const userAnswer = quizInputs[0].value.trim();
        return userAnswer === currentWord.chinese;
      }
    }

    // Handle correct answer
    function handleCorrectAnswer() {
      quizResult.textContent = "‚úÖ Correct!";
      quizResult.className = "alert alert-success";
      quizResult.style.display = 'block';

      if (!hasSecondChance) {
        correctCount++;
        updateScore();
      }

      quizIdx++;

      setTimeout(() => {
        if (quizEnded) return;
        // üî• CORRECTION : Cacher la carte avant de passer √† la question suivante
        hideCharacterCard();
        showQuizWord();
      }, 1200);
    }

    // Handle incorrect answer
    function handleIncorrectAnswer() {
      if (!hasSecondChance) {
        wrongCount++;
        updateScore();

        // Show feedback card with audio and hover functionality
        showCharacterCard(currentWord);

        hasSecondChance = true;

        // Prepare for second chance
        quizInputs.forEach(input => {
          input.value = '';
          input.style.border = '2px solid #dc3545';
          input.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
        });
        quizInputs[0].focus();

        enableSubmitButton();

      } else {
        // Second error
        quizResult.textContent = quizType === 'pinyin' ?
          `‚úÖ Correct answer: ${currentWord.pinyin}` :
          `‚úÖ Correct answer: ${currentWord.chinese}`;

        quizResult.className = "alert alert-warning";
        quizResult.style.display = 'block';

        quizIdx++;

        setTimeout(() => {
          if (quizEnded) return;
          // üî• CORRECTION : Cacher la carte avant de passer √† la question suivante
          hideCharacterCard();
          showQuizWord();
        }, 1200);
      }
    }

    // End quiz
    function endQuiz() {
      quizEnded = true;

      const successRate = (correctCount / quizWords.length) * 100;
      const coinsEarned = calculateCoinsEarned(correctCount, quizWords.length);

      // üî• CORRECTION : Cacher la carte de feedback √† la fin du quiz
      hideCharacterCard();

      // üî• NOUVEAU : Interface de fin de quiz SIMPLIFI√âE
      showQuizCompletedScreen(correctCount, quizWords.length, coinsEarned);
    }

    // Calculate earned coins
    function calculateCoinsEarned(correct, total) {
      const successRate = (correct / total) * 100;

      if (correct === 0) return 0;
      if (successRate <= 50) return 2;
      if (successRate <= 70) return 3;
      return 5;
    }

    // üî• NOUVELLE FONCTION : Interface de fin de quiz SIMPLIFI√âE
    function showQuizCompletedScreen(correct, total, coinsEarned) {
      const successRate = (correct / total) * 100;

      // Message de motivation
      let motivationMessage = '';
      if (successRate >= 80) {
        motivationMessage = 'Outstanding! You\'re a Chinese master!';
      } else if (successRate >= 60) {
        motivationMessage = 'Great job! You\'re making excellent progress!';
      } else if (successRate >= 40) {
        motivationMessage = 'Good effort! Keep practicing to improve!';
      } else {
        motivationMessage = 'Practice makes perfect! Don\'t give up!';
      }

      const quizContainer = document.querySelector('.quiz-container');

      quizContainer.innerHTML = `
    <div class="text-center p-4">
      <!-- Ic√¥ne et titre -->
      <div class="mb-4">
        <h2 class="mt-3 fw-bold">Quiz Completed</h2>
      </div>
      
      <!-- Score -->
      <div class="card border-0 bg-light mb-4">
        <div class="card-body p-4">
          <div class="display-4 fw-bold mb-2">${correct}/${total}</div>
          <div class="text-muted mb-3">${Math.round(successRate)}% correct</div>
        </div>
      </div>
      
      <!-- Message de motivation -->
      <div class="mb-4">
        <p class="lead">${motivationMessage}</p>
      </div>
      
      <!-- R√©compense -->
      ${coinsEarned > 0 ? `
        <div class="alert alert-success border-0 mb-4">
          <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-coin fs-1 me-3"></i>
            <div>
              <h5 class="fw-bold mb-1">+${coinsEarned} Coins Earned</h5>
              <p class="mb-0">Your reward has been added to your balance</p>
            </div>
          </div>
        </div>
      ` : ''}
      
      <!-- Bouton unique -->
      <div class="mt-4">
        ${coinsEarned > 0 ? `
          <button id="collectBtn" class="btn btn-success btn-lg w-100">
            <i class="bi bi-wallet2 me-2"></i>Collect ${coinsEarned}‚Çµ
          </button>
        ` : `
          <button id="finishBtn" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-check-circle me-2"></i>End Quiz
          </button>
        `}
      </div>
    </div>
  `;

      // Gestion du bouton
      if (coinsEarned > 0) {
        document.getElementById('collectBtn').addEventListener('click', saveQuizResults);
      } else {
        document.getElementById('finishBtn').addEventListener('click', saveQuizResults);
      }
    }

    // Save results
    function saveQuizResults() {
      const coinsEarned = calculateCoinsEarned(correctCount, quizWords.length);

      const quizData = {
        score: correctCount,
        total_questions: quizWords.length,
        quiz_type: quizType,
        results: quizResults,
        words_used: quizWords.map(word => quizType === 'pinyin' ? word.pinyin : word.chinese)
      };

      // D√©sactiver le bouton pendant la sauvegarde
      const button = document.getElementById('collectBtn') || document.getElementById('finishBtn');
      if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
      }

      fetch('/api/quiz/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(quizData)
        })
        .then(response => response.json())
        .then(data => {
          console.log('‚úÖ Quiz saved:', data);
          // Rediriger vers la page de s√©lection de quiz
          setTimeout(() => {
            window.location.href = '/quiz';
          }, 500);
        })
        .catch(error => {
          console.error('‚ùå Save error:', error);
          // R√©activer le bouton en cas d'erreur
          if (button) {
            button.disabled = false;
            button.innerHTML = coinsEarned > 0 ?
              `<i class="bi bi-wallet2 me-2"></i>Collect ${coinsEarned}‚Çµ` :
              `<i class="bi bi-check-circle me-2"></i>End Quiz`;
          }
        });
    }

    // Return to selection
    function returnToSelection() {
      if (quizIdx > 0 && !quizEnded) {
        if (confirm('Do you really want to quit? Your progress will be lost.')) {
          window.location.href = '/quiz';
        }
      } else {
        window.location.href = '/quiz';
      }
    }

    // ==================================================
    // FONCTIONS POUR LA CARTE DE CARACT√àRE
    // ==================================================

    // Functions for character card
    function showCharacterCard(word) {
      const card = document.createElement('div');
      card.className = 'card card-custom-bg rounded-4 shadow-sm p-3 mb-3 mx-auto';
      card.style.cssText = 'width: 280px; max-width: 100%; background: #FFF4F2; border: 1px solid #FDA297;';
      card.id = 'character-card-feedback';

      const hskLevelDisplay = word.hsk || 'Street';
      const chineseFontSizeClass = word.chinese && word.chinese.length >= 3 ? 'fs-2' : 'fs-1';

      card.innerHTML = `
        <div class="card-body text-center p-0">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-secondary">
                    HSK ${hskLevelDisplay}
                </span>
                <button class="btn btn-sm btn-outline-primary btn-audio" 
                        data-text="${word.chinese}"
                        title="Listen pronunciation">
                    <i class="bi bi-volume-up"></i>
                </button>
            </div>
            <div class="bg-white border rounded-3 p-3">
                <div class="${chineseFontSizeClass} text-dark chinese-clickable" 
                     data-word-id="${word.id}"
                     data-chinese-text="${word.chinese}"
                     style="min-height: 60px; display: flex; align-items: center; justify-content: center;">
                    ${word.chinese}
                </div>
            </div>
            <div class="mt-2 text-muted small">${word.pinyin}</div>
        </div>
    `;

      quizForm.parentNode.insertBefore(card, quizForm);

      // Activate audio buttons (utilise les fonctions de card-function.js)
      if (window.activateAudioButtons) {
        window.activateAudioButtons(card);
      } else {
        // Fallback simple
        const audioBtn = card.querySelector('.btn-audio');
        if (audioBtn) {
          audioBtn.addEventListener('click', function() {
            const text = this.getAttribute('data-text');
            if (window.textToSpeech) {
              window.textToSpeech(text, 'zh-CN');
            } else if ('speechSynthesis' in window) {
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.lang = 'zh-CN';
              utterance.rate = 0.8;
              speechSynthesis.speak(utterance);
            }
          });
        }
      }

      // Transform Chinese characters for hover (utilise les fonctions de card-function.js)
      if (window.transformChineseCharacters) {
        const chineseContainer = card.querySelector('.chinese-clickable');
        if (chineseContainer && word.chinese) {
          window.transformChineseCharacters(word.chinese, chineseContainer);
        }
      }
    }

    function hideCharacterCard() {
      const card = document.getElementById('character-card-feedback');
      if (card) card.remove();
    }

    // Make quizWords available globally for hover functionality
    window.quizWords = quizWords;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>