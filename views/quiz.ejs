<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz - Âä†Ê≤πÔºÅ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0d6efd" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>

  <style>
    .quiz-card {
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      height: 100%;
    }

    .quiz-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }

    .quiz-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .pinyin-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .character-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .quiz-btn {
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transition: all 0.3s ease;
    }

    .quiz-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.05);
    }

    .count-option {
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid #e9ecef;
    }

    .count-option:hover {
      border-color: #0d6efd;
      background-color: #f8f9fa;
    }

    .count-option.selected {
      border-color: #0d6efd;
      background-color: #e3f2fd;
    }
  </style>
</head>

<body>

  <%- include('partials/header') %>
    <%- include('partials/navbar', {currentPage: currentPage}) %>

      <section class="container my-4">
        <!-- üî• DEUX QUIZ C√îTE √Ä C√îTE -->
        <div class="row g-4">
          <!-- Quiz Pinyin -->
          <div class="col-12 col-lg-6">
            <div class="quiz-card card p-4 pinyin-card">
              <div class="card-body text-center">
                <!-- üî• NOUVEL IC√îNE : Langue internationale -->
                <i class="quiz-icon bi bi-type"></i>
                <h3 class="card-title">Quiz Pinyin</h3>
                <p class="card-text mb-4">From english to pinyin</p>
                <button class="btn quiz-btn btn-lg w-100" onclick="openCountModal('pinyin')">
                  <i class="bi bi-play-circle me-2"></i>Start now !
                </button>
              </div>
            </div>
          </div>

          <!-- Quiz Caract√®res -->
          <div class="col-12 col-lg-6">
            <div class="quiz-card card p-4 character-card">
              <div class="card-body text-center">
                <!-- üî• NOUVEL IC√îNE : Langue chinoise -->
                <i class="quiz-icon bi bi-translate"></i>
                <h3 class="card-title">Quiz characters</h3>
                <p class="card-text mb-4">From English to chinese characters</p>
                <button class="btn quiz-btn btn-lg w-100" onclick="openCountModal('character')">
                  <i class="bi bi-play-circle me-2"></i>Start now !
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- üî• MODAL POUR CHOISIR LE NOMBRE DE MOTS ET FILTRE HSK -->
      <div class="modal fade" id="countModal" tabindex="-1">
        <div class="modal-dialog modal-large">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Amount of words</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <!-- FILTRE HSK AJOUT√â ICI -->
              <div class="mb-4">
                <label class="form-label fw-medium">Filter by HSK level</label>
                <select class="form-select" id="hskFilter">
                  <option value="all">All levels</option>
                  <option value="1">HSK 1</option>
                  <option value="2">HSK 2</option>
                  <option value="3">HSK 3</option>
                  <option value="4">HSK 4</option>
                  <option value="5">HSK 5</option>
                  <option value="6">HSK 6</option>
                  <option value="street">Street Chinese</option>
                </select>
              </div>

              <div class="d-grid gap-2">
                <div class="count-option p-3 rounded text-center" data-count="10" onclick="selectCount(10)">
                  <i class="bi bi-1-circle me-2"></i><strong>10 words</strong>
                  <small class="d-block text-muted">Fast</small>
                </div>
                <div class="count-option p-3 rounded text-center" data-count="20" onclick="selectCount(20)">
                  <i class="bi bi-2-circle me-2"></i><strong>20 words</strong>
                  <small class="d-block text-muted">Standard</small>
                </div>
                <div class="count-option p-3 rounded text-center" data-count="30" onclick="selectCount(30)">
                  <i class="bi bi-3-circle me-2"></i><strong>30 words</strong>
                  <small class="d-block text-muted">Serious</small>
                </div>
                <div class="count-option p-3 rounded text-center" data-count="all" onclick="selectCount(100)">
                  <i class="bi bi-infinity me-2"></i><strong>100 words</strong>
                  <small class="d-block text-muted">Are you crazy ma ?</small>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">cancel</button>
              <button type="button" class="btn btn-primary" id="startQuizBtn" onclick="startQuiz()" disabled>
                <i class="bi bi-rocket-takeoff me-2"></i>Start the quiz
              </button>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="/js/global.js"></script>
      <script>
        let selectedQuizType = null;
        let selectedCount = null;

        // üî• OUVRE LA MODAL POUR CHOISIR LE NOMBRE
        function openCountModal(quizType) {
          selectedQuizType = quizType;
          selectedCount = null;

          // Mettre √† jour le titre de la modal
          const modalTitle = document.getElementById('modalTitle');
          modalTitle.textContent = `Quiz ${quizType === 'pinyin' ? 'Pinyin' : 'Caract√®res'} - Nombre de mots`;

          // R√©initialiser la s√©lection
          document.querySelectorAll('.count-option').forEach(option => {
            option.classList.remove('selected');
          });

          // D√©sactiver le bouton de d√©marrage
          document.getElementById('startQuizBtn').disabled = true;

          // Afficher la modal
          const modal = new bootstrap.Modal(document.getElementById('countModal'));
          modal.show();
        }

        // üî• S√âLECTIONNE UN NOMBRE
        function selectCount(count) {
          selectedCount = count;

          // Mettre √† jour l'UI
          document.querySelectorAll('.count-option').forEach(option => {
            option.classList.remove('selected');
            if (option.getAttribute('data-count') == count) {
              option.classList.add('selected');
            }
          });

          // Activer le bouton de d√©marrage
          document.getElementById('startQuizBtn').disabled = false;
        }

        async function startQuiz() {
          if (!selectedQuizType || !selectedCount) return;

          const hskFilter = document.getElementById('hskFilter').value;

          // D√©sactiver le bouton imm√©diatement
          const startBtn = document.getElementById('startQuizBtn');
          const originalHTML = startBtn.innerHTML; // üî• SAUVEGARDER
          startBtn.disabled = true;
          startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';

          try {
            // Test rapide pour v√©rifier la limite
            const testResponse = await fetch('/quiz-mots?count=1');

            if (testResponse.status === 403) {
              const limitData = await testResponse.json();

              // Fermer la modal de s√©lection
              bootstrap.Modal.getInstance(document.getElementById('countModal')).hide();

              // Petite pause pour l'animation
              setTimeout(() => {
                showQuizLimitPopup(limitData);
              }, 300);

              return;
            }

            // Si OK, rediriger
            const quizUrl = `/quiz-play?type=${selectedQuizType}&count=${selectedCount}&hsk=${hskFilter}`;
            bootstrap.Modal.getInstance(document.getElementById('countModal')).hide();

            // Petite animation avant redirection
            setTimeout(() => {
              window.location.href = quizUrl;
            }, 200);

          } catch (error) {
            // En cas d'erreur, rediriger quand m√™me (meilleure UX)
            console.log('‚ö†Ô∏è Error checking limit, proceeding anyway:', error);

            const quizUrl = `/quiz-play?type=${selectedQuizType}&count=${selectedCount}&hsk=${hskFilter}`;
            bootstrap.Modal.getInstance(document.getElementById('countModal')).hide();

            setTimeout(() => {
              window.location.href = quizUrl;
            }, 200);

          } finally {
            // üî• TOUJOURS r√©initialiser le bouton, m√™me en cas d'erreur
            // (mais seulement si la modal est encore ouverte)
            const countModal = document.getElementById('countModal');
            if (countModal && countModal.classList.contains('show')) {
              startBtn.disabled = false;
              startBtn.innerHTML = originalHTML;
            }
          }
        }

        // Navigation
        function setActiveNavItem() {
          const path = window.location.pathname;
          document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            const dataPage = link.getAttribute('data-page');
            const href = link.getAttribute('href');
            if ((dataPage && path.includes(dataPage)) || (href && path === href)) {
              link.classList.add('active');
            }
          });
        }

        document.addEventListener('DOMContentLoaded', setActiveNavItem);

        // üî• ANIMATION AU SURVOL DES OPTIONS
        document.addEventListener('DOMContentLoaded', function () {
          document.querySelectorAll('.count-option').forEach(option => {
            option.addEventListener('mouseenter', function () {
              this.style.transform = 'scale(1.02)';
            });

            option.addEventListener('mouseleave', function () {
              this.style.transform = 'scale(1)';
            });
          });
        });

        // Fonction pour g√©rer les erreurs de limite de quiz
        function handleQuizLimitError(errorData) {
          if (errorData.limitReached && errorData.type === 'quiz') {
            showQuizLimitPopup(errorData);
            return true;
          }
          return false;
        }

        // Popup pour limite de quiz
        function showQuizLimitPopup(data) {
          console.log('üéØ Showing quiz limit popup:', data);

          // üî• R√âINITIALISER LE BOUTON "Start the quiz"
          const startBtn = document.getElementById('startQuizBtn');
          if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-2"></i>Start the quiz';
          }

          // Supprimer toute popup existante
          document.querySelectorAll('.quiz-limit-popup').forEach(el => el.remove());

          // Cr√©er l'overlay
          const overlay = document.createElement('div');
          overlay.className = 'quiz-limit-popup';
          overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;

          // Cr√©er la modal
          const modal = document.createElement('div');
          modal.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 28px 24px 24px;
    width: 100%;
    max-width: 340px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  `;

          const current = data.current || 5;
          const max = data.max || 5;

          modal.innerHTML = `
    <div style="text-align: center; margin-bottom: 16px; font-size: 1.1rem; font-weight: 600; color: #000;">
      Daily Quiz Limit
    </div>
    
    <div style="text-align: center; color: #666; font-size: 0.94rem; line-height: 1.5; margin-bottom: 28px;">
      You've already taken <strong>${current}</strong> quizzes today.<br>
      Free users are limited to ${max} quizzes per day.
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <a href="/pricing" 
         onclick="this.closest('.quiz-limit-popup')?.remove()"
         style="
           display: block;
           text-align: center;
           background: #007AFF;
           color: white;
           padding: 12px;
           border-radius: 10px;
           text-decoration: none;
           font-weight: 500;
           border: none;
           font-size: 0.95rem;
         ">
        <i class="bi bi-star-fill me-2"></i>
        Upgrade to Premium
      </a>
      
      <button onclick="this.closest('.quiz-limit-popup')?.remove()"
              style="
                background: transparent;
                border: 1.5px solid #D1D1D6;
                color: #000;
                padding: 12px;
                border-radius: 10px;
                font-weight: 500;
                font-size: 0.95rem;
                cursor: pointer;
              ">
        OK
      </button>
    </div>
  `;

          // Fermer en cliquant sur l'overlay
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              overlay.remove();
              // üî• R√âINITIALISER LE BOUTON QUAND ON FERME LA POPUP
              if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-rocket-takeoff me-2"></i>Start the quiz';
              }
            }
          });

          // Ajouter au DOM
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
        }

        // Dans votre code de quiz, interceptez les erreurs
        async function loadQuizWords() {
          try {
            const response = await fetch('/quiz-mots?count=10');

            if (!response.ok) {
              const errorData = await response.json();

              // V√©rifier si c'est une limite
              if (errorData.limitReached && errorData.type === 'quiz') {
                showQuizLimitPopup(errorData);
                return;
              }

              throw new Error(errorData.error || 'Failed to load quiz');
            }

            const words = await response.json();
            // ... afficher le quiz

          } catch (error) {
            console.error('Error loading quiz:', error);
            // Afficher une erreur g√©n√©rique
          }
        }

      </script>

</body>

</html>