<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= profileUser.name %> - Âä†Ê≤πÔºÅ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .progress-container {
            margin: 1rem 0;
        }
        .progress {
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.6s ease;
        }
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clickable-row:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="bg-light">
    <%- include('partials/header') %>
    <%- include('partials/navbar', {currentPage: 'duels'}) %>

    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button onclick="window.history.back()" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <% if (!isOwnProfile) { %>
                <button class="btn btn-primary btn-sm" onclick="openDuelModal(<%= profileUser.id %>, '<%= profileUser.name %>')">
                    <i class="bi bi-sword me-1"></i> Challenge
                </button>
            <% } %>
        </div>

        <!-- Profile Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-body text-center">
                <i class="bi bi-person-circle fs-1 text-primary mb-3"></i>
                <h4 class="card-title"><%= profileUser.name %></h4>
                
                <!-- Stats principales -->
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h5 mb-1 text-primary"><%= stats.total_words || 0 %></div>
                        <small class="text-muted">Words</small>
                    </div>
                    <div class="col-6">
                        <div class="h5 mb-1 text-warning"><%= stats.total_duels || 0 %></div>
                        <small class="text-muted">Duels</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="bi bi-graph-up me-2"></i>
                    Performance
                </h6>
            </div>
            <div class="card-body">
                <!-- Stats globales -->
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <div class="h5 mb-1" id="totalWords">-</div>
                        <div class="text-muted small">Words</div>
                    </div>
                    <div class="col-4">
                        <div class="h5 mb-1" id="totalQuizzes">-</div>
                        <div class="text-muted small">Quizzes</div>
                    </div>
                    <div class="col-4">
                        <div class="h5 mb-1" id="totalDuels">-</div>
                        <div class="text-muted small">Duels</div>
                    </div>
                </div>
                
                <!-- Jauge de progression -->
                <div class="progress-container">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" id="masteredBar" role="progressbar" style="width: 0%"></div>
                        <div class="progress-bar bg-info" id="learningBar" role="progressbar" style="width: 0%"></div>
                        <div class="progress-bar bg-warning" id="mediumBar" role="progressbar" style="width: 0%"></div>
                        <div class="progress-bar bg-secondary" id="newBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center text-muted mt-2" style="font-size: 0.8rem;">
                        <span id="masteryText">0% mastered words</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Duels r√©cents de cet utilisateur -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="bi bi-clock me-2"></i>
                    Recent duels
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="user-recent-duels">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <p class="mt-2 text-muted small">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal D√©fi - M√äME QUE LA PAGE DUELS -->
    <div class="modal fade" id="duelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">challenge <span id="opponentName"></span></h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="duelForm">
                        <input type="hidden" id="opponentId">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-medium">Duel type</label>
                            <select class="form-select" id="duelType" required>
                                <option value="classic">Classic (20 words)</option>
                                <option value="match_aa">Match AA (10 words in commom)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="betAmount" class="form-label">Mise (coins)</label>
                            <input type="number" id="betAmount" class="form-control" min="0" value="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createDuel()">
                        Send a duel 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentOpponent = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadPerformanceStats();
            loadUserRecentDuels();
        });

        // Chargement des performances
        async function loadPerformanceStats() {
            try {
                const response = await fetch(`/account-info?user_id=<%= profileUser.id %>`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('Performance data received:', data);
                
                // Mise √† jour des totaux
                document.getElementById('totalWords').textContent = data.wordCount || 0;
                document.getElementById('totalQuizzes').textContent = data.stats?.total_quizzes || 0;
                document.getElementById('totalDuels').textContent = data.stats?.total_duels || 0;
                
                const words = data.user_mots || [];
                console.log('Words found:', words.length);
                
                if (words.length === 0) {
                    console.log('No words found');
                    document.getElementById('masteryText').textContent = 'No words';
                    return;
                }
                
                // Compte le nombre de mots dans chaque cat√©gorie
                const mastered = words.filter(w => w.score >= 90).length;
                const learning = words.filter(w => w.score >= 60 && w.score < 90).length;
                const medium = words.filter(w => w.score >= 30 && w.score < 60).length;
                const new_words = words.filter(w => w.score < 30).length;
                
                console.log('Score distribution:', { mastered, learning, medium, new_words });
                
                // Calculer les pourcentages
                const total = words.length;
                const bars = {
                    masteredBar: (mastered / total) * 100,
                    learningBar: (learning / total) * 100,
                    mediumBar: (medium / total) * 100,
                    newBar: (new_words / total) * 100
                };
                
                console.log('Percentages:', bars);
                
                // Mettre √† jour les barres
                Object.entries(bars).forEach(([id, percentage]) => {
                    const bar = document.getElementById(id);
                    if (bar) {
                        bar.style.width = `${percentage}%`;
                        console.log(`Setting ${id} width to ${percentage}%`);
                        bar.title = `${Math.round(percentage)}%`;
                    } else {
                        console.warn(`Bar element ${id} not found`);
                    }
                });
                
                const masteredPercentage = Math.round((mastered / total) * 100);
                document.getElementById('masteryText').textContent = `${masteredPercentage}% mastered words`;
                
            } catch (error) {
                console.error('Erreur chargement performances:', error);
                displayPerformanceError();
            }
        }

        function displayPerformanceError() {
            const container = document.querySelector('.card-body');
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-warning small mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Unable to load performance data
                    </div>
                `;
            }
        }

        // Duels r√©cents de l'utilisateur
        async function loadUserRecentDuels() {
            try {
                const response = await fetch(`/api/duels/user-history?user_id=<%= profileUser.id %>&limit=6`);
                const duels = await response.json();
                const container = document.getElementById('user-recent-duels');

                if (duels.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-sword fs-2 opacity-50"></i>
                            <p class="mt-2 small">Aucun duel</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = duels.map(duel => renderDuelItem(duel, <%= profileUser.id %>, false)).join('');

            } catch (error) {
                console.error('Erreur duels r√©cents:', error);
                document.getElementById('user-recent-duels').innerHTML = `
                    <div class="alert alert-warning m-3 small">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Erreur de chargement
                    </div>
                `;
            }
        }

        // M√äME FONCTION renderDuelItem QUE LA PAGE DUELS
        function renderDuelItem(duel, userId, isPending) {
            const isChallenger = duel.challenger_id === userId;
            const opponentName = isChallenger ? duel.opponent_name : duel.challenger_name;
            const userScore = isChallenger ? duel.challenger_score : duel.opponent_score;
            const opponentScore = isChallenger ? duel.opponent_score : duel.challenger_score;
            const hasUserPlayed = userScore !== null;
            const hasOpponentPlayed = opponentScore !== null;

            let status = '', cta = '';

            if (isPending) {
                if (!hasUserPlayed) {
                    status = '<span class="badge bg-primary">√Ä jouer</span>';
                    cta = `<button class="btn btn-sm btn-primary" onclick="playDuel(${duel.id})">Jouer</button>`;
                } else {
                    status = '<span class="badge bg-secondary">En attente</span>';
                    cta = '';
                }
            } else {
                const userWon = userScore > opponentScore;
                const isDraw = userScore === opponentScore;
                
                if (isDraw) {
                    status = '<span class="badge bg-warning">Even</span>';
                } else if (userWon) {
                    status = '<span class="badge bg-success">Victory</span>';
                } else {
                    status = '<span class="badge bg-danger">Defeated</span>';
                }
                cta = '';
            }

            // Affichage du montant du pari
            const betDisplay = duel.bet_amount > 0 ? 
                `<span class="badge bg-warning text-dark ms-2"><i class="bi bi-coin me-1"></i>${duel.bet_amount}</span>` : 
                '';

            // Rendre la ligne cliquable si le duel est termin√©
            const isCompleted = !isPending && hasUserPlayed && hasOpponentPlayed;
            const clickableClass = isCompleted ? 'clickable-row' : '';
            const onClick = isCompleted ? `onclick="viewDuelDetails(${duel.id})"` : '';

            return `
                <div class="list-item d-flex justify-content-between align-items-center border-bottom p-3 ${clickableClass}" 
                    ${onClick}
                    style="${isCompleted ? 'cursor: pointer; transition: background-color 0.2s;' : ''}"
                    onmouseover="${isCompleted ? 'this.style.backgroundColor=\"#f8f9fa\"' : ''}"
                    onmouseout="${isCompleted ? 'this.style.backgroundColor=\"\"' : ''}">
                    <div class="d-flex align-items-center">
                        <div class="avatar me-3">
                            <i class="bi bi-person"></i>
                        </div>
                        <div>
                            <div class="small fw-medium">
                                ${opponentName}
                                ${betDisplay}
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                ${userScore !== null ? userScore : '?'} - ${opponentScore !== null ? opponentScore : '?'}
                                ${status}
                            </div>
                        </div>
                    </div>
                    ${cta}
                </div>
            `;
        }

        // M√äMES FONCTIONS QUE LA PAGE DUELS
        function viewDuelDetails(duelId) {
            window.location.href = `/duel/${duelId}`;
        }

        function playDuel(duelId) {
            window.location.href = `/duel-play/${duelId}`;
        }

        function openDuelModal(opponentId, opponentName) {
            currentOpponent = opponentId;
            document.getElementById('opponentName').textContent = opponentName;
            document.getElementById('opponentId').value = opponentId;
            new bootstrap.Modal(document.getElementById('duelModal')).show();
        }

        async function createDuel() {
            const duelType = document.getElementById('duelType').value;
            const betAmount = parseInt(document.getElementById('betAmount').value) || 0;

            console.log('üöÄ Lancement cr√©ation duel', { currentOpponent, duelType, betAmount });

            try {
                const response = await fetch('/api/duels/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        opponent_id: currentOpponent,
                        duel_type: duelType,
                        quiz_type: 'pinyin',
                        bet_amount: betAmount
                    })
                });

                console.log('‚è≥ R√©ponse re√ßue, status:', response.status);

                const result = await response.json();
                console.log('üî• JSON r√©cup√©r√©:', result);

                if (result.success) {
                    console.log('‚úÖ Duel cr√©√© avec succ√®s, fermeture modal');
                    bootstrap.Modal.getInstance(document.getElementById('duelModal')).hide();
                    showAlert('D√©fi lanc√© !', 'success');
                } else {
                    console.warn('‚ö†Ô∏è Erreur dans cr√©ation duel:', result.error);
                    showAlert(result.error, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau ou fetch:', error);
                showAlert('Erreur r√©seau', 'danger');
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
            alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }
    </script>
</body>
</html>